import{B as U}from"./bbi-OcoD63vi.js";import{A as T}from"./AbortablePromiseCache-Bzbqdtb1.js";import{Q as z}from"./remoteFile-j31HQyZd.js";import{O as R}from"./Observable-WA3-VfeJ.js";import{bo as $,af as P,ah as H,ag as _,u as N}from"./index-DQP-8m57.js";import{a as j,m as L}from"./merge-MY4MXMlR.js";import{B as M,a as q}from"./util-D9Jm-xty.js";import{B as G}from"./index-8HxHVJ6-.js";import{r as J}from"./rxjs-ZYIyRYdN.js";import"./browser-DdKr-yeI.js";function Y(V){return V.filter(e=>!!e)}class X extends U{constructor(){super(...arguments),this.readIndicesCache=new T({cache:new z({maxSize:1}),fill:(e,t)=>this._readIndices({...e,signal:t})})}readIndices(e={}){const{signal:t,...s}=e;return this.readIndicesCache.get(JSON.stringify(s),e,t)}async getView(e,t){return this.getUnzoomedView(t)}async _readIndices(e){const{extHeaderOffset:t}=await this.getHeader(e),s=await this.bbi.read(64,Number(t)),n=new DataView(s.buffer,s.byteOffset,s.length);let i=0;i+=2;const p=n.getUint16(i,!0);i+=2;const d=Number(n.getBigUint64(i,!0));if(i+=8,p===0)return[];const o=20,u=o*p,B=await this.bbi.read(u,Number(d)),l=[];for(let y=0;y<p;y+=1){const g=B.subarray(y*o),w=new DataView(g.buffer,g.byteOffset,g.length);let r=0;const c=w.getInt16(r,!0);r+=2;const f=w.getInt16(r,!0);r+=2;const m=Number(w.getBigUint64(r,!0));r+=12;const S=w.getInt16(r,!0);l.push({type:c,fieldcount:f,offset:Number(m),field:S})}return l}async searchExtraIndexBlocks(e,t={}){const s=await this.readIndices(t);if(s.length===0)return[];const n=new TextDecoder("utf8"),i=s.map(async p=>{const{offset:d,field:o}=p,u=await this.bbi.read(32,d,t),B=new DataView(u.buffer,u.byteOffset,u.length);let l=0;l+=4;const y=B.getInt32(l,!0);l+=4;const g=B.getInt32(l,!0);l+=4;const w=B.getInt32(l,!0);l+=4,l+=8;const r=async c=>{const f=Number(c),m=4+y*(g+w),b=await this.bbi.read(m,f,t),I=new DataView(b.buffer,b.byteOffset,b.length);let a=0;const h=I.getInt8(a);a+=2;const k=I.getInt16(a,!0);a+=2;const C=[];if(h===0){const x=[];for(let E=0;E<k;E++){const F=n.decode(b.subarray(a,a+g)).replaceAll("\0","");a+=g;const A=Number(I.getBigUint64(a,!0));a+=8,x.push({key:F,offset:A})}let O=0;for(const{key:E,offset:F}of x){if(e.localeCompare(E)<0&&O)return r(O);O=F}return r(O)}else if(h===1){for(let x=0;x<k;x++){const O=n.decode(b.subarray(a,a+g)).replaceAll("\0","");a+=g;const E=Number(I.getBigUint64(a,!0));a+=8;const F=I.getUint32(a,!0);a+=4;const A=I.getUint32(a,!0);a+=4,C.push({key:O,offset:E,length:F,reserved:A})}for(const x of C)if(x.key===e)return{...x,field:o};return}};return r(d+32)});return Y(await Promise.all(i))}async searchExtraIndex(e,t={}){const s=await this.searchExtraIndexBlocks(e,t);if(s.length===0)return[];const n=await this.getUnzoomedView(t),i=s.map(d=>new R(o=>{n.readFeatures(o,[d],t).catch(u=>{o.error(u)})}).pipe($((o,u)=>o.concat(u)),j(o=>{for(const u of o)u.field=d.field;return o})));return(await P(L(...i))).filter(d=>{var o;return((o=d.rest)==null?void 0:o.split("	")[(d.field||0)-3])===e})}}class fe extends G.BaseFeatureDataAdapter{async configurePre(e){const t=this.pluginManager,s=new X({filehandle:H.openLocation(this.getConf("bigBedLocation"),t)}),n=await s.getHeader(e),i=new M({autoSql:n.autoSql});return{bigbed:s,header:n,parser:i}}async configure(e){return this.cachedP||(this.cachedP=this.configurePre(e).catch(t=>{throw this.cachedP=void 0,t})),this.cachedP}async getRefNames(e){const{header:t}=await this.configure(e);return Object.keys(t.refsByName)}async getRefNameAliases(e){const{header:t}=await this.configure(e);return(await Promise.all(Object.keys(t.refsByName).map(async n=>(await P(this.getFeatures({assemblyName:"",refName:n,start:0,end:1}).pipe(_())))[0]))).map(n=>n.toJSON()).map(n=>({refName:n.ucsc,aliases:[n.ncbi,n.refseq,n.genbank],override:!0}))}async getData(){const e=await this.getRefNames(),t=[];for(const s of e){const n=await P(this.getFeatures({assemblyName:"unknown",refName:s,start:0,end:Number.MAX_SAFE_INTEGER}).pipe(_()));t.push(n)}return t.flat()}async getHeader(e){const{parser:t,header:s}=await this.configure(e),{version:n,fileType:i}=s,{fields:p,...d}=t.autoSql;return{version:n,fileType:i,autoSql:d,fields:await this.getMetadata(e)}}async getMetadata(e){const{parser:t}=await this.configure(e),{fields:s}=t.autoSql;return Object.fromEntries(s.map(({name:n,comment:i})=>[n,i]))}async getFeaturesHelper({query:e,opts:t,observer:s,allowRedispatch:n,originalQuery:i=e}){const{statusCallback:p=()=>{}}=t,d=this.getConf("scoreColumn"),o=this.getConf("aggregateField"),{parser:u,bigbed:B}=await N.updateStatus("Downloading header",p,()=>this.configure(t)),l=await N.updateStatus("Downloading features",p,()=>B.getFeatures(e.refName,e.start,e.end,{basesPerSpan:e.end-e.start}));await N.updateStatus("Processing features",p,async()=>{var y;const g={},w=[];if(l.some(r=>r.uniqueId===void 0))throw new Error("found uniqueId undefined");for(const r of l){const c=[e.refName,`${r.start}`,`${r.end}`,...((y=r.rest)===null||y===void 0?void 0:y.split("	"))||[]],f=u.parseLine(c,{uniqueId:r.uniqueId}),m=f[o],S=m&&m!=="none";S&&!g[m]&&(g[m]=[]);const{uniqueId:b,type:I,chrom:a,chromStart:h,chromEnd:k,description:C,chromStarts:x,blockStarts:O,blockSizes:E,score:F,blockCount:A,thickStart:K,thickEnd:Q,strand:W,...D}=f,v=q({...D,scoreColumn:d,splitLine:c,parser:u,uniqueId:b,start:r.start,end:r.end,refName:e.refName});S?(g[m].push(v),w.push(v)):N.doesIntersect2(v.start,v.end,i.start,i.end)&&s.next(new N.SimpleFeature({id:`${this.id}-${b}`,data:v}))}if(n&&w.length){let r=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(const f of w)f.start<r&&(r=f.start),f.end>c&&(c=f.end);if(c>e.end||r<e.start){await this.getFeaturesHelper({query:{...e,start:r-5e5,end:c+5e5},opts:t,observer:s,allowRedispatch:!1,originalQuery:e});return}}Object.entries(g).map(([r,c])=>{var f,m,S;const b=N.min(c.map(a=>a.start)),I=N.max(c.map(a=>a.end));if(N.doesIntersect2(b,I,i.start,i.end)){const a=c.sort((h,k)=>h.uniqueId.localeCompare(k.uniqueId));if(a.every(h=>{var k;return h.strand===(((k=a[0])===null||k===void 0?void 0:k.strand)||1)}))s.next(new N.SimpleFeature({id:`${this.id}-${(f=a[0])===null||f===void 0?void 0:f.uniqueId}-parent`,data:{type:"gene",subfeatures:a,strand:((m=a[0])===null||m===void 0?void 0:m.strand)||1,name:r,start:b,end:I,refName:e.refName}}));else for(const h of a)s.next(new N.SimpleFeature({id:`${this.id}-${h.uniqueId}-parent`,data:{type:"gene",subfeatures:[h],strand:((S=a[0])===null||S===void 0?void 0:S.strand)||1,name:r,start:h.start,end:h.end,refName:e.refName}}))}})}),s.complete()}getFeatures(e,t={}){return J.ObservableCreate(async s=>{try{await this.getFeaturesHelper({query:{...e,start:e.start,end:e.end},opts:t,observer:s,allowRedispatch:!0})}catch(n){s.error(n)}},t.stopToken)}}export{fe as default};
//# sourceMappingURL=BigBedAdapter-vlRjs-_x.js.map
