{"version":3,"file":"MCScanSimpleAnchorsAdapter-gp6YB-PF.js","sources":["../../node_modules/@jbrowse/plugin-comparative-adapters/esm/MCScanSimpleAnchorsAdapter/MCScanSimpleAnchorsAdapter.js"],"sourcesContent":["import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { doesIntersect2 } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport SimpleFeature from '@jbrowse/core/util/simpleFeature';\nimport { parseBed, readFile } from '../util';\nclass MCScanAnchorsAdapter extends BaseFeatureDataAdapter {\n    async setup(opts) {\n        if (!this.setupP) {\n            this.setupP = this.setupPre(opts).catch((e) => {\n                this.setupP = undefined;\n                throw e;\n            });\n        }\n        return this.setupP;\n    }\n    async setupPre(opts) {\n        const assemblyNames = this.getConf('assemblyNames');\n        const pm = this.pluginManager;\n        const bed1 = openLocation(this.getConf('bed1Location'), pm);\n        const bed2 = openLocation(this.getConf('bed2Location'), pm);\n        const mcscan = openLocation(this.getConf('mcscanSimpleAnchorsLocation'), pm);\n        const [bed1text, bed2text, mcscantext] = await Promise.all([bed1, bed2, mcscan].map(r => readFile(r, opts)));\n        const bed1Map = parseBed(bed1text);\n        const bed2Map = parseBed(bed2text);\n        const feats = mcscantext\n            .split(/\\n|\\r\\n|\\r/)\n            .filter(f => !!f && f !== '###')\n            .map((line, index) => {\n            const [n11, n12, n21, n22, score, strand] = line.split('\\t');\n            const r11 = bed1Map.get(n11);\n            const r12 = bed1Map.get(n12);\n            const r21 = bed2Map.get(n21);\n            const r22 = bed2Map.get(n22);\n            if (!r11 || !r12 || !r21 || !r22) {\n                throw new Error(`feature not found, ${n11} ${n12} ${n21} ${n22} ${r11} ${r12} ${r21} ${r22}`);\n            }\n            return [\n                r11,\n                r12,\n                r21,\n                r22,\n                +score,\n                strand === '-' ? -1 : 1,\n                index,\n            ];\n        });\n        return {\n            assemblyNames,\n            feats,\n        };\n    }\n    async hasDataForRefName() {\n        return true;\n    }\n    getAssemblyNames() {\n        const assemblyNames = this.getConf('assemblyNames');\n        return assemblyNames;\n    }\n    async getRefNames(opts = {}) {\n        var _a;\n        const r1 = (_a = opts.regions) === null || _a === void 0 ? void 0 : _a[0].assemblyName;\n        const { feats } = await this.setup(opts);\n        const idx = this.getAssemblyNames().indexOf(r1);\n        if (idx !== -1) {\n            const set = new Set();\n            for (const feat of feats) {\n                if (idx === 0) {\n                    set.add(feat[0].refName);\n                    set.add(feat[1].refName);\n                }\n                else {\n                    set.add(feat[2].refName);\n                    set.add(feat[3].refName);\n                }\n            }\n            return [...set];\n        }\n        console.warn('Unable to do ref renaming on adapter');\n        return [];\n    }\n    getFeatures(region, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            const { assemblyNames, feats } = await this.setup(opts);\n            const index = assemblyNames.indexOf(region.assemblyName);\n            if (index !== -1) {\n                const flip = index === 0;\n                for (const f of feats) {\n                    const [f11, f12, f21, f22, score, strand, rowNum] = f;\n                    let r1 = {\n                        refName: f11.refName,\n                        start: Math.min(f11.start, f12.start),\n                        end: Math.max(f11.end, f12.end),\n                    };\n                    let r2 = {\n                        refName: f21.refName,\n                        start: Math.min(f21.start, f22.start),\n                        end: Math.max(f21.end, f22.end),\n                    };\n                    if (!flip) {\n                        ;\n                        [r2, r1] = [r1, r2];\n                    }\n                    if (r1.refName === region.refName &&\n                        doesIntersect2(r1.start, r1.end, region.start, region.end)) {\n                        observer.next(new SimpleFeature({\n                            ...r1,\n                            uniqueId: `${rowNum}`,\n                            syntenyId: rowNum,\n                            assemblyName: assemblyNames[+!flip],\n                            score,\n                            strand,\n                            mate: {\n                                ...r2,\n                                assemblyName: assemblyNames[+flip],\n                            },\n                        }));\n                    }\n                }\n            }\n            observer.complete();\n        });\n    }\n    freeResources() { }\n}\nMCScanAnchorsAdapter.capabilities = ['getFeatures', 'getRefNames'];\nexport default MCScanAnchorsAdapter;\n"],"names":["MCScanAnchorsAdapter","BaseFeatureDataAdapter","opts","e","assemblyNames","pm","bed1","openLocation","bed2","mcscan","bed1text","bed2text","mcscantext","r","readFile","bed1Map","parseBed","bed2Map","feats","f","line","index","n11","n12","n21","n22","score","strand","r11","r12","r21","r22","_a","r1","idx","set","feat","region","ObservableCreate","observer","flip","f11","f12","f21","f22","rowNum","r2","doesIntersect2","SimpleFeature"],"mappings":"oHAMA,MAAMA,UAA6BC,EAAAA,sBAAuB,CACtD,MAAM,MAAMC,EAAM,CACd,OAAK,KAAK,SACN,KAAK,OAAS,KAAK,SAASA,CAAI,EAAE,MAAOC,GAAM,CAC3C,WAAK,OAAS,OACRA,CACtB,CAAa,GAEE,KAAK,MACpB,CACI,MAAM,SAASD,EAAM,CACjB,MAAME,EAAgB,KAAK,QAAQ,eAAe,EAC5CC,EAAK,KAAK,cACVC,EAAOC,EAAAA,aAAa,KAAK,QAAQ,cAAc,EAAGF,CAAE,EACpDG,EAAOD,EAAAA,aAAa,KAAK,QAAQ,cAAc,EAAGF,CAAE,EACpDI,EAASF,EAAAA,aAAa,KAAK,QAAQ,6BAA6B,EAAGF,CAAE,EACrE,CAACK,EAAUC,EAAUC,CAAU,EAAI,MAAM,QAAQ,IAAI,CAACN,EAAME,EAAMC,CAAM,EAAE,IAAII,GAAKC,EAASD,EAAGX,CAAI,CAAC,CAAC,EACrGa,EAAUC,EAASN,CAAQ,EAC3BO,EAAUD,EAASL,CAAQ,EAC3BO,EAAQN,EACT,MAAM,YAAY,EAClB,OAAOO,GAAK,CAAC,CAACA,GAAKA,IAAM,KAAK,EAC9B,IAAI,CAACC,EAAMC,IAAU,CACtB,KAAM,CAACC,EAAKC,EAAKC,EAAKC,EAAKC,EAAOC,CAAM,EAAIP,EAAK,MAAM,GAAI,EACrDQ,EAAMb,EAAQ,IAAIO,CAAG,EACrBO,EAAMd,EAAQ,IAAIQ,CAAG,EACrBO,EAAMb,EAAQ,IAAIO,CAAG,EACrBO,EAAMd,EAAQ,IAAIQ,CAAG,EAC3B,GAAI,CAACG,GAAO,CAACC,GAAO,CAACC,GAAO,CAACC,EACzB,MAAM,IAAI,MAAM,sBAAsBT,CAAG,IAAIC,CAAG,IAAIC,CAAG,IAAIC,CAAG,IAAIG,CAAG,IAAIC,CAAG,IAAIC,CAAG,IAAIC,CAAG,EAAE,EAEhG,MAAO,CACHH,EACAC,EACAC,EACAC,EACA,CAACL,EACDC,IAAW,IAAM,GAAK,EACtBN,CACH,CACb,CAAS,EACD,MAAO,CACH,cAAAjB,EACA,MAAAc,CACH,CACT,CACI,MAAM,mBAAoB,CACtB,MAAO,EACf,CACI,kBAAmB,CAEf,OADsB,KAAK,QAAQ,eAAe,CAE1D,CACI,MAAM,YAAYhB,EAAO,GAAI,CACzB,IAAI8B,EACJ,MAAMC,GAAMD,EAAK9B,EAAK,WAAa,MAAQ8B,IAAO,OAAS,OAASA,EAAG,CAAC,EAAE,aACpE,CAAE,MAAAd,CAAO,EAAG,MAAM,KAAK,MAAMhB,CAAI,EACjCgC,EAAM,KAAK,iBAAgB,EAAG,QAAQD,CAAE,EAC9C,GAAIC,IAAQ,GAAI,CACZ,MAAMC,EAAM,IAAI,IAChB,UAAWC,KAAQlB,EACXgB,IAAQ,GACRC,EAAI,IAAIC,EAAK,CAAC,EAAE,OAAO,EACvBD,EAAI,IAAIC,EAAK,CAAC,EAAE,OAAO,IAGvBD,EAAI,IAAIC,EAAK,CAAC,EAAE,OAAO,EACvBD,EAAI,IAAIC,EAAK,CAAC,EAAE,OAAO,GAG/B,MAAO,CAAC,GAAGD,CAAG,CAC1B,CACQ,eAAQ,KAAK,sCAAsC,EAC5C,CAAE,CACjB,CACI,YAAYE,EAAQnC,EAAO,GAAI,CAC3B,OAAOoC,EAAiB,MAAOC,GAAa,CACxC,KAAM,CAAE,cAAAnC,EAAe,MAAAc,CAAK,EAAK,MAAM,KAAK,MAAMhB,CAAI,EAChDmB,EAAQjB,EAAc,QAAQiC,EAAO,YAAY,EACvD,GAAIhB,IAAU,GAAI,CACd,MAAMmB,EAAOnB,IAAU,EACvB,UAAWF,KAAKD,EAAO,CACnB,KAAM,CAACuB,EAAKC,EAAKC,EAAKC,EAAKlB,EAAOC,EAAQkB,CAAM,EAAI1B,EACpD,IAAIc,EAAK,CACL,QAASQ,EAAI,QACb,MAAO,KAAK,IAAIA,EAAI,MAAOC,EAAI,KAAK,EACpC,IAAK,KAAK,IAAID,EAAI,IAAKC,EAAI,GAAG,CACjC,EACGI,EAAK,CACL,QAASH,EAAI,QACb,MAAO,KAAK,IAAIA,EAAI,MAAOC,EAAI,KAAK,EACpC,IAAK,KAAK,IAAID,EAAI,IAAKC,EAAI,GAAG,CACjC,EACIJ,IAED,CAACM,EAAIb,CAAE,EAAI,CAACA,EAAIa,CAAE,GAElBb,EAAG,UAAYI,EAAO,SACtBU,iBAAed,EAAG,MAAOA,EAAG,IAAKI,EAAO,MAAOA,EAAO,GAAG,GACzDE,EAAS,KAAK,IAAIS,EAAc,CAC5B,GAAGf,EACH,SAAU,GAAGY,CAAM,GACnB,UAAWA,EACX,aAAczC,EAAc,CAAC,CAACoC,CAAI,EAClC,MAAAd,EACA,OAAAC,EACA,KAAM,CACF,GAAGmB,EACH,aAAc1C,EAAc,CAACoC,CAAI,CACpC,CAC7B,CAAyB,CAAC,CAE1B,CACA,CACYD,EAAS,SAAU,CAC/B,CAAS,CACT,CACI,eAAgB,CAAA,CACpB,CACAvC,EAAqB,aAAe,CAAC,cAAe,aAAa","x_google_ignoreList":[0]}