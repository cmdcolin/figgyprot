import{a3 as P,aJ as L,cg as F,a7 as O}from"./index-CT2bM4yV.js";import{z as I,B as R,i as B,p as $,O as j,f as k,s as E,b as v}from"./util-eIttPhVK.js";import{S as z}from"./index-DviPGhcF.js";function _(i){const t={};for(const e of i){const a=e.qname,c=e.tname,m=`${a}-${c}`;t[m]||(t[m]={quals:[],len:[]}),t[m].quals.push(e.extra.mappingQual||1),t[m].len.push(e.extra.blockLen||1)}const s=Object.fromEntries(Object.entries(t).map(([e,a])=>{const c=I(a.quals,a.len);return[e,D(c)]}));for(const e of i){const a=e.qname,c=e.tname,m=`${a}-${c}`;e.extra.meanScore=s[m]}let n=1e4,r=0;for(const e of i)n=Math.min(e.extra.meanScore||0,n),r=Math.max(e.extra.meanScore||0,r);for(const e of i){const a=e.extra.meanScore||0;e.extra.meanScore=(a-n)/(r-n)}return i}function D(i){const[t,s]=i.reduce(([n,r],[e,a])=>[n+e*a,r+a],[0,0]);return t/s}const{parseCigar:Q}=O;class U extends R.BaseFeatureDataAdapter{async setup(t){return this.setupP||(this.setupP=this.setupPre(t).catch(s=>{throw this.setupP=void 0,s})),this.setupP}async setupPre(t){const s=this.pluginManager,n=B.openLocation(this.getConf("pafLocation"),s),r=await P.fetchAndMaybeUnzip(n,t);return $(r,v,t)}async hasDataForRefName(){return!0}getAssemblyNames(){const t=this.getConf("assemblyNames");if(t.length===0){const s=this.getConf("queryAssembly"),n=this.getConf("targetAssembly");return[s,n]}return t}async getRefNames(t={}){var s;const n=(s=t.regions)===null||s===void 0?void 0:s[0].assemblyName,r=await this.setup(t),e=this.getAssemblyNames().indexOf(n);if(e!==-1){const a=new Set;for(const c of r)a.add(e===0?c.qname:c.tname);return[...a]}return console.warn("Unable to do ref renaming on adapter"),[]}getFeatures(t,s={}){return j(async n=>{let r=await this.setup(s);const{config:e}=s;e&&L.readConfObject(e,"colorBy")==="meanQueryIdentity"&&(r=_(r));const a=this.getAssemblyNames(),{start:c,end:m,refName:C,assemblyName:l}=t,N=a.indexOf(l),p=N===0;N===-1&&(console.warn(`${l} not found in this adapter`),n.complete());for(let f=0;f<r.length;f++){const o=r[f];let d=0,y=0,g="",h="",b=0,q=0;p?(d=o.qstart,y=o.qend,g=o.qname,h=o.tname,b=o.tstart,q=o.tend):(d=o.tstart,y=o.tend,g=o.tname,h=o.qname,b=o.qstart,q=o.qend);const{extra:u,strand:A}=o;if(g===C&&F(c,m,d,y)){const{numMatches:S=0,blockLen:w=1,cg:G,...M}=u;let x=u.cg;u.cg&&(p&&A===-1?x=k(Q(u.cg)).join(""):p&&(x=E(u.cg))),n.next(new z({uniqueId:f+l,assemblyName:l,start:d,end:y,type:"match",refName:g,strand:A,...M,CIGAR:x,syntenyId:f,identity:S/w,numMatches:S,blockLen:w,mate:{start:b,end:q,refName:h,assemblyName:a[+p]}}))}}n.complete()})}freeResources(){}}U.capabilities=["getFeatures","getRefNames"];export{U as default};
//# sourceMappingURL=PAFAdapter-C7rCfCH-.js.map
