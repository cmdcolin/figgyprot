import{I as E}from"./main-BPWpXae6.js";import{dD as F,dE as x,dF as g,dG as A}from"./index-CT2bM4yV.js";const I=["seq_name","source","featureType","start","end","score","strand","frame","attributes"];function y(i){return i===null?null:String(i).replace(/%([0-9A-Fa-f]{2})/g,(t,e)=>String.fromCharCode(parseInt(e,16)))}function k(i,t){return String(t).replace(i,e=>{let r=e.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r=`0${r}`),`%${r}`})}function v(i){return k(/[\n;\r\t=%&,\x00-\x1f\x7f-\xff]/g,i)}function L(i){return k(/[\n\r\t%\x00-\x1f\x7f-\xff]/g,i)}function $(i){if(!(i&&i.length)||i===".")return{};const t={};return i.replace(/\r?\n$/,"").slice(0,-1).split(";").forEach(e=>{if(!e)return;const r=e.trim().split(" ");if(!(r[1]&&r[1].length))return;r[0]=r[0].trim();let n=t[r[0].trim()];n||(n=[],t[r[0]]=n),n.push(...r[1].split(",").map(a=>a.trim()).map(y))}),t}function N(i){const t=i.split("	").map(r=>r==="."?null:r);t[0]=y(t[0]),t[1]=y(t[1]),t[2]=y(t[2]),t[8]=$(t[8]);const e={};for(let r=0;r<I.length;r+=1)e[I[r]]=t[r]==="."?null:t[r];return e.start!==null&&(e.start=parseInt(e.start,10)),e.end!==null&&(e.end=parseInt(e.end,10)),e.score!==null&&(e.score=parseFloat(e.score,10)),e.strand!=null&&(e.strand=e.strand),e}function j(i){const t=/^\s*##\s*(\S+)\s*(.*)/.exec(i);if(!t)return null;const e=t[1];let r=t[2];const n={directive:e};if(r.length&&(r=r.replace(/\r?\n$/,""),n.value=r),e==="sequence-region"){const[a,s,c]=r.split(/\s+/,3);n.seq_id=a,n.start=s&&s.replace(/\D/g,""),n.end=c&&c.replace(/\D/g,"")}else if(e==="genome-build"){const[a,s]=r.split(/\s+/,2);n.source=a,n.buildname=s}return n}function D(i){const t=[];return Object.keys(i).forEach(e=>{const r=i[e];let n;r.hasOwnProperty("toString")?n=v(r.toString()):Array.isArray(r.values)?n=r.values.map(v).join(","):Array.isArray(r)?n=r.map(v).join(","):n=v(r),t.push(`${v(e)} ${n}`)}),t.length?t.join("; ").concat(";"):"."}const M=["-",".","+"];function R(i,t){const e=i.attributes===null||i.attributes===void 0?".":D(i.attributes),r=[];for(let a=0;a<8;a+=1){const s=i[I[a]];a===6?r[a]=s==null?".":M[s+1]||s:r[a]=s==null?".":L(String(s))}r[8]=e;const n=`${r.join("	")}
`;return t[n]?"":(t[n]=!0,n)}function T(i,t){if(Array.isArray(i))return i.map(r=>T(r,t)).join("");const e=[R(i,t)];return["child_features","derived_features"].forEach(r=>{i[r]&&e.push(...i[r].map(n=>T(n,t)))}),e.join("")}function B(i){return T(i,{})}const O={Parent:"child_features",Derives_from:"derived_features"};class q{constructor(t){const e=()=>{};Object.assign(this,{featureCallback:t.featureCallback||e,endCallback:t.endCallback||e,commentCallback:t.commentCallback||e,errorCallback:t.errorCallback||e,directiveCallback:t.directiveCallback||e,sequenceCallback:t.sequenceCallback||e,bufferSize:t.bufferSize===void 0?1e3:t.bufferSize,_underConstructionTopLevel:[],_underConstructionById:{},_completedReferences:{},_underConstructionOrphans:{},eof:!1,lineNumber:0})}addLine(t){if(this.eof)return;if(this.lineNumber+=1,/^\s*[^#\s>]/.test(t)){this._bufferLine(t);return}const e=/^\s*(#+)(.*)/.exec(t);if(e){let[,r,n]=e;if(r.length===3)this._emitAllUnderConstructionFeatures();else if(r.length===2){const a=j(t);this._emitItem(a)}else n=n.replace(/\s*/,""),this._emitItem({comment:n})}else if(!/^\s*$/.test(t)){const r=t.replace(/\r?\n?$/g,"");throw new Error(`GTF parse error.  Cannot parse '${r}'.`)}}_emitItem(t){t[0]?this.featureCallback(t):t.directive?this.directiveCallback(t):t.comment&&this.commentCallback(t)}finish(){this._emitAllUnderConstructionFeatures(),this.endCallback()}_enforceBufferSizeLimit(t=0){const e=r=>{var n,a,s;!((s=(a=(n=r==null?void 0:r[0])===null||n===void 0?void 0:n.attributes)===null||a===void 0?void 0:a.ID)===null||s===void 0)&&s[0]&&(r[0].attributes.ID.forEach(f=>{delete this._underConstructionById[f],delete this._completedReferences[f]}),r.forEach(f=>{f.child_features&&f.child_features.forEach(o=>{e(o)}),f.derived_features&&f.derived_features.forEach(o=>{e(o)})}))};for(;this._underConstructionTopLevel.length+t>this.bufferSize;){const r=this._underConstructionTopLevel.shift();this._emitItem(r),e(r)}}_emitAllUnderConstructionFeatures(){if(this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={},Object.values(this._underConstructionOrphans).filter(t=>Object.keys(t).length).length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${JSON.stringify(this._underConstructionOrphans)}`)}_bufferLine(t){const e=N(t);e.child_features=[],e.derived_features=[];const r=this.lineNumber,n=e.featureType==="transcript",a=n?e.attributes.transcript_id||[]:[r],s=n?[]:e.attributes.transcript_id||[],c=e.attributes.Derives_from||[];if(!a.length&&!s.length&&!c.length){this._emitItem([e]);return}function f(h){const u=JSON.parse(JSON.stringify(h));return u.featureType="transcript",B(u)}s.forEach(h=>{this._underConstructionById[h]||this._bufferLine(f(e))});let o;a.forEach(h=>{const u=this._underConstructionById[h];u?(u.push(e),o=u):(o=[e],this._enforceBufferSizeLimit(1),!s.length&&!c.length&&this._underConstructionTopLevel.push(o),this._underConstructionById[h]=o,this._resolveReferencesTo(o,h))}),this._resolveReferencesFrom(o||[e],{Parent:s,Derives_from:c},a)}_resolveReferencesTo(t,e){const r=this._underConstructionOrphans[e];r&&Object.keys(r).forEach(n=>{const a=O[n]||n.toLowerCase();t.forEach(s=>{s[a].push(...r[n]),delete r[n]})})}_parseError(t){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${t}`)}_resolveReferencesFrom(t,e,r){function n(s,c,f){let o=s[c];o||(o={},s[c]=o);const h=o[f]||!1;return o[f]=!0,h}function a(s,c){s[0].start=Math.min(s[0].start,c[0].start),s[0].end=Math.max(s[0].end,c[0].end)}Object.entries(e).forEach(([s,c])=>{let f;c.forEach(o=>{const h=this._underConstructionById[o];h?(a(h,t),f||(f=O[s]||s.toLowerCase()),r.filter(u=>n(this._completedReferences,u,`${s},${o}`)).length||h.forEach(u=>{u[f].push(t)})):(this._underConstructionOrphans[o]||(this._underConstructionOrphans[o]={}),this._underConstructionOrphans[o][s]||(this._underConstructionOrphans[o][s]=[]),this._underConstructionOrphans[o][s].push(t))})})}}function P(i){if(!i)return[];const t=[],e=new q({featureCallback:r=>t.push(r),errorCallback:r=>{throw r}});for(const r of i.split(/\r?\n/))e.addLine(r);return e.finish(),t}function w(i,t){const e={...i};e.start-=1,e.strand={"+":1,"-":-1,".":0,"?":void 0}[i.strand],e.phase=Number(i.frame),e.refName=i.seq_name,i.score===null&&(e.score=void 0),i.frame===null&&(e.score=void 0);const r=new Set(["start","end","seq_name","score","featureType","source","frame","strand"]);for(const n of Object.keys(i.attributes)){let a=n.toLowerCase();if(r.has(a)&&(a+="2"),i.attributes[n]){let s=i.attributes[n];Array.isArray(s)&&s.length===1&&(s=s[0].replaceAll(/^"|"$/g,"")),e[a]=s}}return e.refName=e.seq_name,e.type=e.featureType,i.child_features&&i.child_features.length>0&&(e.subfeatures=i.child_features.flatMap(n=>n.map(a=>w(a)))),e.child_features=void 0,e.data=void 0,e.derived_features=void 0,e._linehash=void 0,e.attributes=void 0,e.seq_name=void 0,e.featureType=void 0,e.frame=void 0,e.transcript_id&&(e.name=e.transcript_id),t!==void 0&&(e.uniqueId=t),e}class U extends F.BaseFeatureDataAdapter{constructor(){super(...arguments),this.calculatedIntervalTreeMap={}}async loadDataP(t){const{statusCallback:e=()=>{}}=t||{},r=x.openLocation(this.getConf("gtfLocation"),this.pluginManager),n=await g.fetchAndMaybeUnzip(r,t),a=[],s={};let c=0,f=0;const o=new TextDecoder("utf8");for(;c<n.length;){const u=n.indexOf(10,c),_=u===-1?n.subarray(c):n.subarray(c,u),p=o.decode(_).trim();if(p)if(p.startsWith("#"))a.push(p);else{if(p.startsWith(">"))break;{const d=p.indexOf("	"),l=p.slice(0,d);s[l]||(s[l]=""),s[l]+=`${p}
`}}f++%1e4===0&&e(`Loading ${g.getProgressDisplayStr(c,n.length)}`),c=u+1}const h=Object.fromEntries(Object.entries(s).map(([u,_])=>[u,p=>{if(!this.calculatedIntervalTreeMap[u]){p==null||p("Parsing GTF data");const d=new E;for(const l of P(_).flat().map((b,m)=>w(b,`${this.id}-${u}-${m}`)))d.insert([l.start,l.end],l);this.calculatedIntervalTreeMap[u]=d}return this.calculatedIntervalTreeMap[u]}]));return{header:a.join(`
`),intervalTreeMap:h}}async loadData(t={}){return this.gtfFeatures||(this.gtfFeatures=this.loadDataP(t).catch(e=>{throw this.gtfFeatures=void 0,e})),this.gtfFeatures}async getRefNames(t={}){const{intervalTreeMap:e}=await this.loadData(t);return Object.keys(e)}async getHeader(t={}){const{header:e}=await this.loadData(t);return e}getFeatures(t,e={}){return A(async r=>{try{await this.getFeaturesHelper({query:t,opts:e,observer:r,allowRedispatch:!0})}catch(n){r.error(n)}},e.stopToken)}async getFeaturesHelper({query:t,opts:e,observer:r,allowRedispatch:n,originalQuery:a=t}){var s;const c=this.getConf("aggregateField"),{start:f,end:o,refName:h}=t,{intervalTreeMap:u}=await this.loadData(e),_=(s=u[h])===null||s===void 0?void 0:s.call(u,e.statusCallback).search([f,o]);if(_){if(n&&_.length){let d=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,b=!1;for(const m of _)m.start<d&&(d=m.start),m.end>l&&(l=m.end),m[c]&&(b=!0);if(b&&(l>t.end||d<t.start)){await this.getFeaturesHelper({query:{...t,start:d-5e5,end:l+5e5},opts:e,observer:r,allowRedispatch:!1,originalQuery:t});return}}const p={};if(_.some(d=>d.uniqueId===void 0))throw new Error("found uniqueId undefined");for(const d of _){const l=d[c];p[l]||(p[l]=[]),l?p[l].push(d):r.next(new g.SimpleFeature({id:d.uniqueId,data:d}))}for(const[d,l]of Object.entries(p)){const b=g.min(l.map(C=>C.start)),m=g.max(l.map(C=>C.end));if(g.doesIntersect2(b,m,a.start,a.end)){const{uniqueId:C,strand:S}=l[0];r.next(new g.SimpleFeature({id:`${C}-parent`,data:{type:"gene",subfeatures:l,strand:S,name:d,start:b,end:m,refName:t.refName}}))}}}r.complete()}freeResources(){}}export{U as default};
//# sourceMappingURL=GtfAdapter-1R2x1zYz.js.map
