var oe=Object.defineProperty;var H=r=>{throw TypeError(r)};var ce=(r,e,t)=>e in r?oe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var _=(r,e,t)=>ce(r,typeof e!="symbol"?e+"":e,t),W=(r,e,t)=>e.has(r)||H("Cannot "+t);var x=(r,e,t)=>(W(r,e,"read from private field"),t?t.call(r):e.get(r)),Y=(r,e,t)=>e.has(r)?H("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),Q=(r,e,t,n)=>(W(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);import{cf as G,ca as z,ce as he,cm as D,d$ as N,e0 as ue,eD as fe,eE as ee,dU as le,eF as de,eG as U,p as L,am as ge,an as me,dW as pe,bb as J,eH as be,eI as we}from"./index-CGKDrrCR.js";import{c as xe}from"./crc32-BNi2TJ31.js";class V{constructor(e,t,n,s){_(this,"minv");_(this,"maxv");_(this,"bin");_(this,"_fetchedSize");_(this,"buffer");this.minv=e,this.maxv=t,this.bin=n,this._fetchedSize=s}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}class te{constructor({filehandle:e,renameRefSeq:t=n=>n}){_(this,"filehandle");_(this,"renameRefSeq");this.filehandle=e,this.renameRefSeq=t}}const K=65536,_e=K*K;function ye(r,e=0){const t=r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24;return((r[e+4]|r[e+5]<<8|r[e+6]<<16|r[e+7]<<24)>>>0)*_e+(t>>>0)}function Ie(r){return new Promise(e=>setTimeout(e,r))}function Ce(r){if(r&&r.aborted)if(typeof DOMException>"u"){const e=new Error("aborted");throw e.code="ERR_ABORTED",e}else throw new DOMException("aborted","AbortError")}function Ae(r,e){return e.minv.blockPosition-r.maxv.blockPosition<65e3&&e.maxv.blockPosition-r.minv.blockPosition<5e6}function Se(r={}){return"aborted"in r?{signal:r}:r}function ne(r,e){const t=[];let n;if(r.length===0)return r;r.sort((s,i)=>{const a=s.minv.blockPosition-i.minv.blockPosition;return a===0?s.minv.dataPosition-i.minv.dataPosition:a});for(const s of r)(!e||s.maxv.compareTo(e)>0)&&(n===void 0?(t.push(s),n=s):Ae(n,s)?s.maxv.compareTo(n.maxv)>0&&(n.maxv=s.maxv):(t.push(s),n=s));return t}function se(r,e){return{lineCount:ye(r,e)}}function q(r,e){return r?r.compareTo(e)>0?e:r:e}function Re(r,e=t=>t){let t=0,n=0;const s=[],i={};for(let a=0;a<r.length;a+=1)if(!r[a]){if(n<a){let o="";for(let h=n;h<a;h++)o+=String.fromCharCode(r[h]);o=e(o),s[t]=o,i[o]=t}n=a+1,t+=1}return{refNameToId:i,refIdToName:s}}function Pe(r){let e=0;for(const t of r)e+=t.length;return e}function je(r){const e=new Uint8Array(Pe(r));let t=0;for(const n of r)e.set(n,t),t+=n.length;return e}async function ke(r){let e=[];for await(const t of r)e=e.concat(t);return e}class ie{constructor(e,t){_(this,"blockPosition");_(this,"dataPosition");this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}}function k(r,e=0,t=!1){if(t)throw new Error("big-endian virtual file offsets not implemented");return new ie(r[e+7]*1099511627776+r[e+6]*4294967296+r[e+5]*16777216+r[e+4]*65536+r[e+3]*256+r[e+2],r[e+1]<<8|r[e])}const ve=21578050;function Fe(r,e){return r-r%e}function Te(r,e){return r-r%e+e}function Ee(r,e){return e-=1,[[0,0],[1+(r>>26),1+(e>>26)],[9+(r>>23),9+(e>>23)],[73+(r>>20),73+(e>>20)],[585+(r>>17),585+(e>>17)],[4681+(r>>14),4681+(e>>14)]]}class E extends te{constructor(){super(...arguments);_(this,"setupP")}async lineCount(t,n){var i,a;return((a=(i=(await this.parse(n)).indices(t))==null?void 0:i.stats)==null?void 0:a.lineCount)||0}async _parse(t){const n=await this.filehandle.readFile(),s=new DataView(n.buffer);if(s.getUint32(0,!0)!==ve)throw new Error("Not a BAI file");const i=s.getInt32(4,!0),o=((1<<(5+1)*3)-1)/7;let h=8,c;const u=[];for(let d=0;d<i;d++){u.push(h);const l=s.getInt32(h,!0);h+=4;for(let m=0;m<l;m+=1){const p=s.getUint32(h,!0);if(h+=4,p===o+1)h+=4,h+=32;else{if(p>o+1)throw new Error("bai index contains too many bins, please use CSI");{const C=s.getInt32(h,!0);h+=4;for(let I=0;I<C;I++)h+=8,h+=8}}}const b=s.getInt32(h,!0);h+=4;const y=new Array(b);for(let m=0;m<b;m++){const p=k(n,h);h+=8,c=q(c,p),y[m]=p}}const g=new G({maxSize:5});function f(d){let l=u[d];if(l===void 0)return;const b=s.getInt32(l,!0);let y;l+=4;const m={};for(let I=0;I<b;I+=1){const A=s.getUint32(l,!0);if(l+=4,A===o+1)l+=4,y=se(n,l+16),l+=32;else{if(A>o+1)throw new Error("bai index contains too many bins, please use CSI");{const R=s.getInt32(l,!0);l+=4;const P=new Array(R);for(let v=0;v<R;v++){const F=k(n,l);l+=8;const T=k(n,l);l+=8,c=q(c,F),P[v]=new V(F,T,A)}m[A]=P}}}const p=s.getInt32(l,!0);l+=4;const C=new Array(p);for(let I=0;I<p;I++){const A=k(n,l);l+=8,c=q(c,A),C[I]=A}return{binIndex:m,linearIndex:C,stats:y}}return{bai:!0,firstDataLine:c,maxBlockSize:65536,indices:d=>{if(!g.has(d)){const l=f(d);return l&&g.set(d,l),l}return g.get(d)},refCount:i}}async indexCov(t,n,s,i){const o=n!==void 0,c=(await this.parse(i)).indices(t);if(!c)return[];const{linearIndex:u=[],stats:g}=c;if(u.length===0)return[];const f=s===void 0?(u.length-1)*16384:Te(s,16384),d=n===void 0?0:Fe(n,16384),l=o?new Array((f-d)/16384):new Array(u.length-1),b=u[u.length-1].blockPosition;if(f>(u.length-1)*16384)throw new Error("query outside of range of linear index");let y=u[d/16384].blockPosition;for(let m=d/16384,p=0;m<f/16384;m++,p++)l[p]={score:u[m+1].blockPosition-y,start:m*16384,end:m*16384+16384},y=u[m+1].blockPosition;return l.map(m=>({...m,score:m.score*((g==null?void 0:g.lineCount)||0)/b}))}async blocksForRange(t,n,s,i={}){n<0&&(n=0);const a=await this.parse(i);if(!a)return[];const o=a.indices(t);if(!o)return[];const h=Ee(n,s),c=[];for(const[l,b]of h)for(let y=l;y<=b;y++)if(o.binIndex[y]){const m=o.binIndex[y];for(const p of m)c.push(new V(p.minv,p.maxv,y))}const u=o.linearIndex.length;let g;const f=Math.min(n>>14,u-1),d=Math.min(s>>14,u-1);for(let l=f;l<=d;++l){const b=o.linearIndex[l];b&&(!g||b.compareTo(g)<0)&&(g=b)}return ne(c,g)}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch(n=>{throw this.setupP=void 0,n})),this.setupP}async hasRefSeq(t,n={}){var i;return!!((i=(await this.parse(n)).indices(t))!=null&&i.binIndex)}}const Me=21582659,qe=38359875;function Be(r,e){return r*2**e}function X(r,e){return Math.floor(r/2**e)}class $ extends te{constructor(){super(...arguments);_(this,"maxBinNumber",0);_(this,"depth",0);_(this,"minShift",0);_(this,"setupP")}async lineCount(t,n){var i,a;return((a=(i=(await this.parse(n)).indices(t))==null?void 0:i.stats)==null?void 0:a.lineCount)||0}async indexCov(){return[]}parseAuxData(t,n){const s=new DataView(t.buffer),i=s.getUint32(n,!0),a=i&65536?"zero-based-half-open":"1-based-closed",o={0:"generic",1:"SAM",2:"VCF"}[i&15];if(!o)throw new Error(`invalid Tabix preset format flags ${i}`);const h={ref:s.getInt32(n+4,!0),start:s.getInt32(n+8,!0),end:s.getInt32(n+12,!0)},c=s.getInt32(n+16,!0),u=c?String.fromCharCode(c):"",g=s.getInt32(n+20,!0),f=s.getInt32(n+24,!0);return{columnNumbers:h,coordinateType:a,metaValue:c,metaChar:u,skipLines:g,format:o,formatFlags:i,...Re(t.subarray(n+28,n+28+f),this.renameRefSeq)}}async _parse(t){const n=await this.filehandle.readFile(t),s=await z(n),i=new DataView(s.buffer);let a;const o=i.getUint32(0,!0);if(o===Me)a=1;else if(o===qe)a=2;else throw new Error(`Not a CSI file ${o}`);this.minShift=i.getInt32(4,!0),this.depth=i.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const h=this.maxBinNumber,c=i.getInt32(12,!0),u=c>=30?this.parseAuxData(s,16):void 0,g=i.getInt32(16+c,!0);let f=16+c+4,d;const l=[];for(let m=0;m<g;m++){l.push(f);const p=i.getInt32(f,!0);f+=4;for(let C=0;C<p;C++){const I=i.getUint32(f,!0);if(f+=4,I>this.maxBinNumber)f+=44;else{f+=8;const A=i.getInt32(f,!0);f+=4;for(let R=0;R<A;R+=1){const P=k(s,f);f+=8,f+=8,d=q(d,P)}}}}const b=new G({maxSize:5});function y(m){let p=l[m];if(p===void 0)return;const C=i.getInt32(p,!0);p+=4;const I={};let A;for(let R=0;R<C;R++){const P=i.getUint32(p,!0);if(p+=4,P>h)A=se(s,p+28),p+=44;else{d=q(d,k(s,p)),p+=8;const v=i.getInt32(p,!0);p+=4;const F=new Array(v);for(let T=0;T<v;T+=1){const re=k(s,p);p+=8;const ae=k(s,p);p+=8,F[T]=new V(re,ae,P)}I[P]=F}}return{binIndex:I,stats:A}}return{csiVersion:a,firstDataLine:d,indices:m=>{if(!b.has(m)){const p=y(m);return p&&b.set(m,p),p}return b.get(m)},refCount:g,csi:!0,maxBlockSize:65536,...u}}async blocksForRange(t,n,s,i={}){n<0&&(n=0);const o=(await this.parse(i)).indices(t);if(!o)return[];const h=this.reg2bins(n,s);if(h.length===0)return[];const c=[];for(const[u,g]of h)for(let f=u;f<=g;f++)if(o.binIndex[f]){const d=o.binIndex[f];for(const l of d)c.push(l)}return ne(c,new ie(0,0))}reg2bins(t,n){t-=1,t<1&&(t=1),n>2**50&&(n=2**34),n-=1;let s=0,i=0,a=this.minShift+this.depth*3;const o=[];for(;s<=this.depth;a-=3,i+=Be(1,s*3),s+=1){const h=i+X(t,a),c=i+X(n,a);if(c-h+o.length>this.maxBinNumber)throw new Error(`query ${t}-${n} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);o.push([h,c])}return o}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch(n=>{throw this.setupP=void 0,n})),this.setupP}async hasRefSeq(t,n={}){var i;return!!((i=(await this.parse(n)).indices(t))!=null&&i.binIndex)}}class De{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}const S={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048},Z="=ACMGRSVTWYHKDBN".split(""),M="MIDNSHP=X???????".split("");var w;class B{constructor(e){_(this,"fileOffset");_(this,"bytes");Y(this,w);this.bytes=e.bytes,this.fileOffset=e.fileOffset,Q(this,w,new DataView(this.bytes.byteArray.buffer))}get byteArray(){return this.bytes.byteArray}get flags(){return(x(this,w).getInt32(this.bytes.start+16,!0)&4294901760)>>16}get ref_id(){return x(this,w).getInt32(this.bytes.start+4,!0)}get start(){return x(this,w).getInt32(this.bytes.start+8,!0)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){const e=(this.bin_mq_nl&65280)>>8;return e===255?void 0:e}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;const e=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes;return this.byteArray.subarray(e,e+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){let e="";for(let t=0;t<this.read_name_length-1;t++)e+=String.fromCharCode(this.byteArray[this.b0+t]);return e}get tags(){let e=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes+this.seq_length;const t=this.bytes.end,n={};for(;e<t;){const s=String.fromCharCode(this.byteArray[e],this.byteArray[e+1]),i=String.fromCharCode(this.byteArray[e+2]);if(e+=3,i==="A")n[s]=String.fromCharCode(this.byteArray[e]),e+=1;else if(i==="i")n[s]=x(this,w).getInt32(e,!0),e+=4;else if(i==="I")n[s]=x(this,w).getUint32(e,!0),e+=4;else if(i==="c")n[s]=x(this,w).getInt8(e),e+=1;else if(i==="C")n[s]=x(this,w).getUint8(e),e+=1;else if(i==="s")n[s]=x(this,w).getInt16(e,!0),e+=2;else if(i==="S")n[s]=x(this,w).getUint16(e,!0),e+=2;else if(i==="f")n[s]=x(this,w).getFloat32(e,!0),e+=4;else if(i==="Z"||i==="H"){const a=[];for(;e<=t;){const o=this.byteArray[e++];if(o!==0)a.push(String.fromCharCode(o));else break}n[s]=a.join("")}else if(i==="B"){const a=this.byteArray[e++],o=String.fromCharCode(a),h=x(this,w).getInt32(e,!0);if(e+=4,o==="i")if(s==="CG"){const c=[];for(let u=0;u<h;u++){const g=x(this,w).getInt32(e,!0),f=g>>4,d=M[g&15];c.push(f+d),e+=4}n[s]=c.join("")}else{const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getInt32(e,!0)),e+=4;n[s]=c}else if(o==="I")if(s==="CG"){const c=[];for(let u=0;u<h;u++){const g=x(this,w).getUint32(e,!0),f=g>>4,d=M[g&15];c.push(f+d),e+=4}n[s]=c.join("")}else{const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getUint32(e,!0)),e+=4;n[s]=c}else if(o==="s"){const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getInt16(e,!0)),e+=2;n[s]=c}else if(o==="S"){const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getUint16(e,!0)),e+=2;n[s]=c}else if(o==="c"){const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getInt8(e)),e+=1;n[s]=c}else if(o==="C"){const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getUint8(e)),e+=1;n[s]=c}else if(o==="f"){const c=[];for(let u=0;u<h;u++)c.push(x(this,w).getFloat32(e,!0)),e+=4;n[s]=c}}else{console.error("Unknown BAM tag type",i);break}}return n}isPaired(){return!!(this.flags&S.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&S.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&S.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&S.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&S.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&S.BAM_FMREVERSE)}isRead1(){return!!(this.flags&S.BAM_FREAD1)}isRead2(){return!!(this.flags&S.BAM_FREAD2)}isSecondary(){return!!(this.flags&S.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&S.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&S.BAM_FDUP)}isSupplementary(){return!!(this.flags&S.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};const e=this.num_cigar_ops;let t=this.b0+this.read_name_length;const n=[];let s=x(this,w).getInt32(t,!0),i=s>>4,a=M[s&15];if(a==="S"&&i===this.seq_length)return t+=4,s=x(this,w).getInt32(t,!0),i=s>>4,a=M[s&15],a!=="N"&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:i};{let o=0;for(let h=0;h<e;++h)s=x(this,w).getInt32(t,!0),i=s>>4,a=M[s&15],n.push(i+a),a!=="H"&&a!=="S"&&a!=="I"&&(o+=i),t+=4;return{CIGAR:n.join(""),length_on_ref:o}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return this.flag_nc&65535}get read_name_length(){return this.bin_mq_nl&255}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){const e=this.b0+this.read_name_length+this.num_cigar_ops*4,t=this.num_seq_bytes,n=this.seq_length,s=[];let i=0;for(let a=0;a<t;++a){const o=this.byteArray[e+a];s.push(Z[(o&240)>>4]),i++,i<n&&(s.push(Z[o&15]),i++)}return s.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){const e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F";let n=" ",s=" ";this.isRead1()?(n="1",s="2"):this.isRead2()&&(n="2",s="1");const i=[];return this.template_length>0?(i[0]=e,i[1]=n,i[2]=t,i[3]=s):(i[2]=e,i[3]=n,i[0]=t,i[1]=s),i.join("")}}get bin_mq_nl(){return x(this,w).getInt32(this.bytes.start+12,!0)}get flag_nc(){return x(this,w).getInt32(this.bytes.start+16,!0)}get seq_length(){return x(this,w).getInt32(this.bytes.start+20,!0)}get next_refid(){return x(this,w).getInt32(this.bytes.start+24,!0)}get next_pos(){return x(this,w).getInt32(this.bytes.start+28,!0)}get template_length(){return x(this,w).getInt32(this.bytes.start+32,!0)}toJSON(){const e={};for(const t of Object.keys(this))t.startsWith("_")||t==="bytes"||(e[t]=this[t]);return e}}w=new WeakMap;function O(r,e){const t=Object.getOwnPropertyDescriptor(r.prototype,e);if(!t)throw new Error("OH NO, NO PROPERTY DESCRIPTOR");const n=t.get;if(!n)throw new Error("OH NO, NOT A GETTER");Object.defineProperty(r.prototype,e,{get(){const s=n.call(this);return Object.defineProperty(this,e,{value:s}),s}})}O(B,"tags");O(B,"cigarAndLength");O(B,"seq");O(B,"qual");function Ne(r){const e=r.split(/\r?\n/),t=[];for(const n of e){const[s,...i]=n.split(/\t/);s&&t.push({tag:s.slice(1),data:i.map(a=>{const o=a.indexOf(":"),h=a.slice(0,o),c=a.slice(o+1);return{tag:h,value:c}})})}return t}const Le=21840194,Oe=65536;class Ue{constructor({bamFilehandle:e,bamPath:t,bamUrl:n,baiPath:s,baiFilehandle:i,baiUrl:a,csiPath:o,csiFilehandle:h,csiUrl:c,htsget:u,yieldThreadTime:g=100,renameRefSeqs:f=d=>d}){_(this,"renameRefSeq");_(this,"bam");_(this,"header");_(this,"chrToIndex");_(this,"indexToChr");_(this,"yieldThreadTime");_(this,"index");_(this,"htsget",!1);_(this,"headerP");_(this,"featureCache",new he({cache:new G({maxSize:50}),fill:async(e,t)=>{const{chunk:n,opts:s}=e,{data:i,cpositions:a,dpositions:o}=await this._readChunk({chunk:n,opts:{...s,signal:t}});return this.readBamFeatures(i,a,o,n)}}));if(this.renameRefSeq=f,e)this.bam=e;else if(t)this.bam=new D(t);else if(n)this.bam=new N(n);else if(u)this.htsget=!0,this.bam=new De;else throw new Error("unable to initialize bam");if(h)this.index=new $({filehandle:h});else if(o)this.index=new $({filehandle:new D(o)});else if(c)this.index=new $({filehandle:new N(c)});else if(i)this.index=new E({filehandle:i});else if(s)this.index=new E({filehandle:new D(s)});else if(a)this.index=new E({filehandle:new N(a)});else if(t)this.index=new E({filehandle:new D(`${t}.bai`)});else if(n)this.index=new E({filehandle:new N(`${n}.bai`)});else if(u)this.htsget=!0;else throw new Error("unable to infer index format");this.yieldThreadTime=g}async getHeaderPre(e){const t=Se(e);if(!this.index)return;const n=await this.index.parse(t),s=n.firstDataLine?n.firstDataLine.blockPosition+65535:void 0;let i;if(s){const f=s+Oe;i=await this.bam.read(f,0)}else i=await this.bam.readFile(t);const a=await z(i),o=new DataView(a.buffer);if(o.getInt32(0,!0)!==Le)throw new Error("Not a BAM file");const h=o.getInt32(4,!0),c=new TextDecoder("utf8");this.header=c.decode(a.subarray(8,8+h));const{chrToIndex:u,indexToChr:g}=await this._readRefSeqs(h+8,65535,t);return this.chrToIndex=u,this.indexToChr=g,Ne(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(t=>{throw this.headerP=void 0,t})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,n){if(e>t)return this._readRefSeqs(e,t*2,n);const s=await this.bam.read(t,0,n),i=await z(s),a=new DataView(i.buffer),o=a.getInt32(e,!0);let h=e+4;const c={},u=[],g=new TextDecoder("utf8");for(let f=0;f<o;f+=1){const d=a.getInt32(h,!0),l=this.renameRefSeq(g.decode(i.subarray(h+4,h+4+d-1))),b=a.getInt32(h+d+4,!0);if(c[l]=f,u.push({refName:l,length:b}),h=h+8+d,h>i.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,t*2,n)}return{chrToIndex:c,indexToChr:u}}async getRecordsForRange(e,t,n,s){return ke(this.streamRecordsForRange(e,t,n,s))}async*streamRecordsForRange(e,t,n,s){var a;await this.getHeader(s);const i=(a=this.chrToIndex)==null?void 0:a[e];if(i===void 0||!this.index)yield[];else{const o=await this.index.blocksForRange(i,t-1,n,s);yield*this._fetchChunkFeatures(o,i,t,n,s)}}async*_fetchChunkFeatures(e,t,n,s,i={}){const{viewAsPairs:a}=i,o=[];let h=!1;for(const c of e){const u=await this.featureCache.get(c.toString(),{chunk:c,opts:i},i.signal),g=[];for(const f of u)if(f.ref_id===t)if(f.start>=s){h=!0;break}else f.end>=n&&g.push(f);if(o.push(g),yield g,h)break}Ce(i.signal),a&&(yield this.fetchPairs(t,o,i))}async fetchPairs(e,t,n){const{pairAcrossChr:s,maxInsertSize:i=2e5}=n,a={},o={};t.map(f=>{const d={};for(const l of f){const b=l.name,y=l.id;d[b]||(d[b]=0),d[b]++,o[y]=1}for(const[l,b]of Object.entries(d))b===1&&(a[l]=!0)});const h=[];t.map(f=>{for(const d of f){const l=d.name,b=d.start,y=d.next_pos,m=d.next_refid;this.index&&a[l]&&(s||m===e&&Math.abs(b-y)<i)&&h.push(this.index.blocksForRange(m,y,y+1,n))}});const c=new Map,u=await Promise.all(h);for(const f of u.flat())c.has(f.toString())||c.set(f.toString(),f);return(await Promise.all([...c.values()].map(async f=>{const{data:d,cpositions:l,dpositions:b,chunk:y}=await this._readChunk({chunk:f,opts:n}),m=[];for(const p of await this.readBamFeatures(d,l,b,y))a[p.name]&&!o[p.id]&&m.push(p);return m}))).flat()}async _readChunk({chunk:e,opts:t}){const n=await this.bam.read(e.fetchedSize(),e.minv.blockPosition,t),{buffer:s,cpositions:i,dpositions:a}=await ue(n,e);return{data:s,cpositions:i,dpositions:a,chunk:e}}async readBamFeatures(e,t,n,s){let i=0;const a=[];let o=0,h=+Date.now();const c=new DataView(e.buffer);for(;i+4<e.length;){const u=c.getInt32(i,!0),g=i+4+u-1;if(n){for(;i+s.minv.dataPosition>=n[o++];);o--}if(g<e.length){const f=new B({bytes:{byteArray:e,start:i,end:g},fileOffset:t.length>0?t[o]*256+(i-n[o])+s.minv.dataPosition+1:xe(e.subarray(i,g))>>>0});a.push(f),this.yieldThreadTime&&+Date.now()-h>this.yieldThreadTime&&(await Ie(1),h=+Date.now())}i=g+1}return a}async hasRefSeq(e){var n,s;const t=(n=this.chrToIndex)==null?void 0:n[e];return t===void 0?!1:(s=this.index)==null?void 0:s.hasRefSeq(t)}async lineCount(e){var n;const t=(n=this.chrToIndex)==null?void 0:n[e];return t===void 0||!this.index?0:this.index.lineCount(t)}async indexCov(e,t,n){var i;if(!this.index)return[];await this.index.parse();const s=(i=this.chrToIndex)==null?void 0:i[e];return s===void 0?[]:this.index.indexCov(s,t,n)}async blocksForRange(e,t,n,s){var a;if(!this.index)return[];await this.index.parse();const i=(a=this.chrToIndex)==null?void 0:a[e];return i===void 0?[]:this.index.blocksForRange(i,t,n,s)}}class j{constructor(e,t,n){this.record=e,this.adapter=t,this.ref=n}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return fe(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var e;return(e=this.record.qual)===null||e===void 0?void 0:e.join(" ")}get(e){return e==="mismatches"?this.mismatches:e==="qual"?this.qual:this.fields[e]}parent(){}children(){}get fields(){const e=this.record,t=this.adapter,n=e.isPaired();return{start:e.start,name:e.name,end:e.end,score:e.score,strand:e.strand,template_length:e.template_length,flags:e.flags,tags:e.tags,refName:t.refIdToName(e.ref_id),CIGAR:e.CIGAR,seq:e.seq,type:"match",pair_orientation:e.pair_orientation,next_ref:n?t.refIdToName(e.next_refid):void 0,next_pos:n?e.next_pos:void 0,next_segment_position:n?`${t.refIdToName(e.next_refid)}:${e.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}ee(j,"fields");ee(j,"mismatches");class $e extends le.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new de({maxSize:500})}async configurePre(){const e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),n=this.getConf(["index","indexType"]),s=this.pluginManager,i=n==="CSI",a=new Ue({bamFilehandle:U.openLocation(e,s),csiFilehandle:i?U.openLocation(t,s):void 0,baiFilehandle:i?void 0:U.openLocation(t,s),yieldThreadTime:Number.POSITIVE_INFINITY}),o=this.getConf("sequenceAdapter");if(o&&this.getSubAdapter){const{dataAdapter:h}=await this.getSubAdapter(o);return{bam:a,sequenceAdapter:h}}return{bam:a}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){const{bam:t}=await this.configure();return t.getHeaderText()}async setupPre(e){const{bam:t}=await this.configure(),n=await t.getHeader(),s=[],i={};if(n)for(const[a,o]of n.filter(h=>h.tag==="SQ").entries()){const h=o.data.find(c=>c.tag==="SN");if(h){const c=h.value;i[c]=a,s[a]=c}}return this.samHeader={idToName:s,nameToId:i},this.samHeader}async setupPre2(e){return this.setupP||(this.setupP=this.setupPre(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async setup(e){const{statusCallback:t=()=>{}}=e||{};return L.updateStatus("Downloading index",t,()=>this.setupPre2(e))}async getRefNames(e){const{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,n){const{sequenceAdapter:s}=await this.configure(),i=s;if(!i||!e)return;const a=i.getFeatures({refName:e,start:t,end:n,assemblyName:""}),o=await ge.firstValueFrom(a.pipe(me.toArray()));let h="";for(const c of o.sort((u,g)=>u.get("start")-g.get("start"))){const u=c.get("start"),g=c.get("end"),f=Math.max(t-u,0),l=Math.min(n-u,g-u)-f,b=c.get("seq")||c.get("residues");h+=b.slice(f,f+l)}if(h.length!==n-t)throw new Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${n.toLocaleString()} returned ${h.length.toLocaleString()} bases, but should have returned ${(n-t).toLocaleString()}`);return h}getFeatures(e,t){const{refName:n,start:s,end:i,originalRefName:a}=e,{stopToken:o,filterBy:h,statusCallback:c=()=>{}}=t||{};return pe(async u=>{const{bam:g}=await this.configure();await this.setup(t),J(o);const f=await L.updateStatus("Downloading alignments",c,()=>g.getRecordsForRange(n,s,i));J(o),await L.updateStatus("Processing alignments",c,async()=>{const{flagInclude:d=0,flagExclude:l=0,tagFilter:b,readName:y}=h||{};for(const m of f){let p;if(m.tags.MD||(p=await this.seqFetch(a||n,m.start,m.end)),be(m.flags,d,l)||b&&we(m.tags[b.tag],b.value)||y&&m.name!==y)continue;const C=this.ultraLongFeatureCache.get(`${m.id}`);if(C)u.next(C);else{const I=new j(m,this,p);this.ultraLongFeatureCache.set(`${m.id}`,I),u.next(I)}}u.complete()})})}async getMultiRegionFeatureDensityStats(e,t){const{bam:n}=await this.configure();if(n.index){const s=await L.bytesForRegions(e,n),i=this.getConf("fetchSizeLimit");return{bytes:s,fetchSizeLimit:i}}return super.getMultiRegionFeatureDensityStats(e,t)}freeResources(){}refIdToName(e){var t;return(t=this.samHeader)===null||t===void 0?void 0:t.idToName[e]}}const He=Object.freeze(Object.defineProperty({__proto__:null,default:$e},Symbol.toStringTag,{value:"Module"}));export{Ue as B,Le as a,$e as b,je as c,He as d,Ne as p};
//# sourceMappingURL=BamAdapter-laHkjVoU.js.map
