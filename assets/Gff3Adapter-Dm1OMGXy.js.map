{"version":3,"file":"Gff3Adapter-Dm1OMGXy.js","sources":["../../node_modules/@jbrowse/plugin-gff3/esm/Gff3Adapter/Gff3Adapter.js"],"sourcesContent":["import IntervalTree from '@flatten-js/interval-tree';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { fetchAndMaybeUnzip, getProgressDisplayStr } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport SimpleFeature from '@jbrowse/core/util/simpleFeature';\nimport { parseStringSync } from 'gff-nostream';\nimport { featureData } from '../featureData';\nexport default class Gff3Adapter extends BaseFeatureDataAdapter {\n    constructor() {\n        super(...arguments);\n        this.calculatedIntervalTreeMap = {};\n    }\n    async loadDataP(opts) {\n        const { statusCallback = () => { } } = opts || {};\n        const buffer = await fetchAndMaybeUnzip(openLocation(this.getConf('gffLocation'), this.pluginManager));\n        const headerLines = [];\n        const featureMap = {};\n        const decoder = new TextDecoder('utf8');\n        let blockStart = 0;\n        let i = 0;\n        while (blockStart < buffer.length) {\n            const n = buffer.indexOf(10, blockStart);\n            const b = n === -1 ? buffer.subarray(blockStart) : buffer.subarray(blockStart, n);\n            const line = decoder.decode(b).trim();\n            if (line) {\n                if (line.startsWith('#')) {\n                    headerLines.push(line);\n                }\n                else if (line.startsWith('>')) {\n                    break;\n                }\n                else {\n                    const ret = line.indexOf('\\t');\n                    const refName = line.slice(0, ret);\n                    if (!featureMap[refName]) {\n                        featureMap[refName] = '';\n                    }\n                    featureMap[refName] += `${line}\\n`;\n                }\n            }\n            if (i++ % 10000 === 0) {\n                statusCallback(`Loading ${getProgressDisplayStr(blockStart, buffer.length)}`);\n            }\n            blockStart = n + 1;\n        }\n        const intervalTreeMap = Object.fromEntries(Object.entries(featureMap).map(([refName, lines]) => [\n            refName,\n            (sc) => {\n                if (!this.calculatedIntervalTreeMap[refName]) {\n                    sc === null || sc === void 0 ? void 0 : sc('Parsing GFF data');\n                    const intervalTree = new IntervalTree();\n                    for (const obj of parseStringSync(lines)\n                        .flat()\n                        .map((f, i) => new SimpleFeature({\n                        data: featureData(f),\n                        id: `${this.id}-${refName}-${i}`,\n                    }))) {\n                        intervalTree.insert([obj.get('start'), obj.get('end')], obj);\n                    }\n                    this.calculatedIntervalTreeMap[refName] = intervalTree;\n                }\n                return this.calculatedIntervalTreeMap[refName];\n            },\n        ]));\n        return {\n            header: headerLines.join('\\n'),\n            intervalTreeMap,\n        };\n    }\n    async loadData(opts) {\n        if (!this.gffFeatures) {\n            this.gffFeatures = this.loadDataP(opts).catch((e) => {\n                this.gffFeatures = undefined;\n                throw e;\n            });\n        }\n        return this.gffFeatures;\n    }\n    async getRefNames(opts = {}) {\n        const { intervalTreeMap } = await this.loadData(opts);\n        return Object.keys(intervalTreeMap);\n    }\n    async getHeader(opts = {}) {\n        const { header } = await this.loadData(opts);\n        return header;\n    }\n    getFeatures(query, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            var _a;\n            try {\n                const { start, end, refName } = query;\n                const { intervalTreeMap } = await this.loadData(opts);\n                for (const f of ((_a = intervalTreeMap[refName]) === null || _a === void 0 ? void 0 : _a.call(intervalTreeMap, opts.statusCallback).search([\n                    start,\n                    end,\n                ])) || []) {\n                    observer.next(f);\n                }\n                observer.complete();\n            }\n            catch (e) {\n                observer.error(e);\n            }\n        }, opts.stopToken);\n    }\n    freeResources() { }\n}\n"],"names":["Gff3Adapter","BaseFeatureDataAdapter","opts","statusCallback","buffer","fetchAndMaybeUnzip","openLocation","headerLines","featureMap","decoder","blockStart","i","n","b","line","ret","refName","getProgressDisplayStr","intervalTreeMap","lines","sc","intervalTree","IntervalTree","obj","parseStringSync","f","SimpleFeature","featureData","e","header","query","ObservableCreate","observer","_a","start","end"],"mappings":"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","x_google_ignoreList":[0]}