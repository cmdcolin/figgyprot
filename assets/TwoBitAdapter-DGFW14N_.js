import{cm as S,aV as I,aZ as x,aW as k,aX as z,dp as _}from"./index-CT2bM4yV.js";const y=BigInt(32);function U(r,e,n){const t=+!!n,a=+!n;return BigInt(r.getInt32(e,n)*a+r.getInt32(e+4,n)*t)<<y|BigInt(r.getUint32(e,n)*t+r.getUint32(e+4,n)*a)}function q(r,e,n){const t=r.getUint32(e,n),a=r.getUint32(e+4,n),s=+!!n,i=+!n;return BigInt(t*i+a*s)<<y|BigInt(t*s+a*i)}"getBigInt64"in DataView||(DataView.prototype.getBigInt64=function(r,e){return U(this,r,e)});"getBigUint64"in DataView||(DataView.prototype.getBigUint64=function(r,e){return q(this,r,e)});const P=440477507,g=["T","C","A","G"],m=[];for(let r=0;r<256;r++)m.push(g[r>>6&3]+g[r>>4&3]+g[r>>2&3]+g[r&3]);const O=m.map(r=>r.toLowerCase());class C{constructor({filehandle:e,path:n}){if(e)this.filehandle=e;else if(n)this.filehandle=new S(n);else throw new Error("must supply path or filehandle")}async _detectEndianness(){const e=await this.filehandle.read(8,0),n=new DataView(e.buffer);if(n.getInt32(0,!0)===P)this.version=n.getInt32(0,!0);else throw new Error("not a 2bit file")}getHeader(){return this.headerP||(this.headerP=this._getHeader().catch(e=>{throw this.headerP=void 0,e})),this.headerP}async _getHeader(){await this._detectEndianness();const e=await this.filehandle.read(16,0),n=!0,t=new DataView(e.buffer,e.byteOffset,e.length);let a=0;const s=t.getInt32(a,n);if(a+=4,s!==440477507)throw new Error(`Wrong magic number ${s}`);const i=t.getInt32(a,n);a+=4;const c=t.getUint32(a,n);a+=4;const o=t.getUint32(a,n);return{version:i,magic:s,sequenceCount:c,reserved:o}}getIndex(){return this.indexP||(this.indexP=this._getIndex().catch(e=>{throw this.indexP=void 0,e})),this.indexP}async _getIndex(){const e=await this.getHeader(),n=8+e.sequenceCount*(257+(this.version===1?8:4)),t=await this.filehandle.read(n,8),a=!0,s=new DataView(t.buffer,t.byteOffset,t.length);let i=0;const c=s.getUint32(i,a);i+=4,i+=4;const o=[],h=new TextDecoder("utf8");for(let l=0;l<c;l++){const u=s.getUint8(i);i+=1;const f=h.decode(t.subarray(i,i+u));if(i+=u,e.version===1){const d=Number(s.getBigUint64(i,a));i+=8,o.push({offset:d,name:f})}else{const d=s.getUint32(i,a);i+=4,o.push({offset:d,name:f})}}return Object.fromEntries(o.map(({name:l,offset:u})=>[l,u]))}async getSequenceNames(){const e=await this.getIndex();return Object.keys(e)}async getSequenceSizes(){const e=await this.getIndex(),n=Object.keys(e),t=await Promise.all(Object.values(e).map(s=>this._getSequenceSize(s))),a={};for(const[s,i]of n.entries())a[i]=t[s];return a}async getSequenceSize(e){const t=(await this.getIndex())[e];return t?this._getSequenceSize(t):void 0}async _getSequenceSize(e){return this._record1(e).then(n=>n.dnaSize)}async _record1(e,n=8){const t=await this.filehandle.read(n,e),a=!0;let s=0;const i=new DataView(t.buffer,t.byteOffset,t.length),c=i.getUint32(s,a);s+=4;const o=i.getUint32(s,a);return s+=4,{dnaSize:c,nBlockCount:o}}async _record2(e,n){const t=await this.filehandle.read(n,e),a=!0;let s=0;const i=new DataView(t.buffer,t.byteOffset,t.length),c=i.getUint32(s,a);s+=4;const o=[];for(let u=0;u<c;u++){const f=i.getUint32(s,a);s+=4,o.push(f)}const h=[];for(let u=0;u<c;u++){const f=i.getUint32(s,a);s+=4,h.push(f)}return{maskBlockCount:i.getUint32(s,a),nBlockSizes:h,nBlockStarts:o}}async _record3(e,n){const t=await this.filehandle.read(n,e),a=!0;let s=0;const i=new DataView(t.buffer,t.byteOffset,t.length),c=i.getUint32(s,a);s+=4;const o=[];for(let u=0;u<c;u++){const f=i.getUint32(s,a);s+=4,o.push(f)}const h=[];for(let u=0;u<c;u++){const f=i.getUint32(s,a);s+=4,h.push(f)}const l=i.getInt32(s,a);return{maskBlockCount:c,maskBlockSizes:h,maskBlockStarts:o,reserved:l}}async _getSequenceRecord(e){const n=await this._record1(e),t=n.nBlockCount*8+8,a=await this._record2(e+4,t),s=a.maskBlockCount*8+8,i=await this._record3(e+4+t-4,s);return{dnaSize:n.dnaSize,nBlocks:{starts:a.nBlockStarts,sizes:a.nBlockSizes},maskBlocks:{starts:i.maskBlockStarts,sizes:i.maskBlockSizes},dnaPosition:e+4+t-4+s}}async getSequence(e,n=0,t=Number.POSITIVE_INFINITY){const s=(await this.getIndex())[e];if(!s)return;const i=await this._getSequenceRecord(s);if(n<0)throw new TypeError("regionStart cannot be less than 0");t>i.dnaSize&&(t=i.dnaSize);const c=this._getOverlappingBlocks(n,t,i.nBlocks.starts,i.nBlocks.sizes),o=this._getOverlappingBlocks(n,t,i.maskBlocks.starts,i.maskBlocks.sizes),h=Math.ceil((t-n)/4)+1,l=Math.floor(n/4),u=await this.filehandle.read(h,i.dnaPosition+l);let f="";for(let d=n;d<t;d+=1){for(;o.length>0&&o[0].end<=d;)o.shift();const B=o[0]&&o[0].start<=d&&o[0].end>d;if(c[0]&&d>=c[0].start&&d<c[0].end){const w=c.shift();for(;d<w.end&&d<t;d+=1)f+=B?"n":"N";d-=1}else{const w=Math.floor(d/4)-l,p=d%4,b=u[w];f+=B?O[b][p]:m[b][p]}}return f}_getOverlappingBlocks(e,n,t,a){let s,i;for(const[o,h]of t.entries()){const l=a[o];if(e>=h+l||n<=h){if(s!==void 0){i=o;break}}else s===void 0&&(s=o)}if(s===void 0)return[];i===void 0&&(i=t.length);const c=new Array(i-s);for(let o=s;o<i;o+=1)c[o-s]={start:t[o],end:t[o]+a[o],size:a[o]};return c}}class V extends I.BaseSequenceAdapter{async initChromSizes(){const e=x.readConfObject(this.config,"chromSizesLocation");if(e.uri!=="/path/to/default.chrom.sizes"&&e.uri!==""){const t=await k.openLocation(e,this.pluginManager).readFile("utf8");return Object.fromEntries(t.split(/\n|\r\n|\r/).filter(a=>!!a.trim()).map(a=>{const[s,i]=a.split("	");return[s,+i]}))}}async setupPre(){return{twobit:new C({filehandle:k.openLocation(this.getConf("twoBitLocation"),this.pluginManager)}),chromSizesData:await this.initChromSizes()}}async setup(){return this.setupP||(this.setupP=this.setupPre().catch(e=>{throw this.setupP=void 0,e})),this.setupP}async getRefNames(){const{chromSizesData:e,twobit:n}=await this.setup();return e?Object.keys(e):n.getSequenceNames()}async getRegions(){const{chromSizesData:e,twobit:n}=await this.setup();if(e)return Object.keys(e).map(t=>({refName:t,start:0,end:e[t]}));{const t=await n.getSequenceSizes();return Object.keys(t).map(a=>({refName:a,start:0,end:t[a]}))}}getFeatures({refName:e,start:n,end:t}){return z(async a=>{const{twobit:s}=await this.setup(),i=await s.getSequenceSize(e),c=i!==void 0?Math.min(i,t):t,o=await s.getSequence(e,n,c);o&&a.next(new _({id:`${e} ${n}-${c}`,data:{refName:e,start:n,end:c,seq:o}})),a.complete()})}freeResources(){}}export{V as default};
//# sourceMappingURL=TwoBitAdapter-DGFW14N_.js.map
