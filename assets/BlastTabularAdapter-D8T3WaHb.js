import{a3 as B,aJ as R}from"./index-CGKDrrCR.js";import{B as L,i as D,p as F,O as v}from"./util-B_L2Y7L7.js";import{S as T}from"./index-CGsrR2gh.js";function j(N){const e=N.trim().split(" "),t=e.indexOf("qseqid");if(t===-1)throw new Error('Missing required column "qseqid"');const s=e.indexOf("sseqid");if(s===-1)throw new Error('Missing required column "sseqid"');const o=e.indexOf("qstart");if(o===-1)throw new Error('Missing required column "qstart"');const r=e.indexOf("qend");if(r===-1)throw new Error('Missing required column "qend"');const d=e.indexOf("sstart");if(d===-1)throw new Error('Missing required column "sstart"');const f=e.indexOf("send");if(f===-1)throw new Error('Missing required column "send"');const q=new Map(e.map((c,n)=>[c,n]).filter(c=>!["qseqid","sseqid","qstart","qend","sstart","send"].includes(c[0])));return c=>{if(c.startsWith("#"))return;const n=c.split("	"),l=n[t],p=n[s],a=n[o],i=n[r],y=n[d],g=n[f];if(!(l&&p&&a&&i&&y&&g)){console.warn("Invalid BLAST line"),console.warn(c);return}const m={qseqid:l,sseqid:p,qstart:Number.parseInt(a),qend:Number.parseInt(i),sstart:Number.parseInt(y),send:Number.parseInt(g)};for(const[u,b]of q.entries()){const h=n[b];h&&(m[u]=h)}return m}}class U extends L.BaseFeatureDataAdapter{getData(e){return this.data||(this.data=this.setup(e).catch(t=>{throw this.data=void 0,t})),this.data}async setup(e){const t=this.pluginManager,s=await B.fetchAndMaybeUnzip(D.openLocation(R.readConfObject(this.config,"blastTableLocation"),t),e),o=R.readConfObject(this.config,"columns");return F(s,j(o),e)}async hasDataForRefName(){return!0}getAssemblyNames(){const e=this.getConf("assemblyNames");if(e.length===0){const t=this.getConf("queryAssembly"),s=this.getConf("targetAssembly");return[t,s]}return e}async getRefNames(e={}){var t;const s=(t=e.regions)===null||t===void 0?void 0:t[0].assemblyName,o=await this.getData(e),r=this.getAssemblyNames().indexOf(s);if(r!==-1){const d=new Set;for(const f of o)d.add(r===0?f.qseqid:f.sseqid);return[...d]}return console.warn("Unable to do ref renaming on adapter"),[]}getFeatures(e,t={}){return v(async s=>{const o=await this.getData(t),[r,d]=this.getAssemblyNames(),{refName:f,assemblyName:q,start:c,end:n}=e;if(q!==d&&q!==r){console.warn(`${q} not found in this adapter`),s.complete();return}for(let l=0;l<o.length;l++){const p=o[l];let a,i,y,g,m,u,b,h;const{qseqid:w,sseqid:x,qstart:A,qend:I,sstart:O,send:E,...C}=p;q===r?(a=A,i=I,y=w,g=r,m=O,u=E,b=x,h=d):(a=O,i=E,y=x,g=d,m=A,u=I,b=w,h=r);let M=1,S=1;a>i&&([a,i]=[i,a],M=-1),m>u&&([m,u]=[u,m],S=-1),y===f&&B.doesIntersect2(c,n,a,i)&&s.next(new T({uniqueId:l+q,assemblyName:g,start:a,end:i,type:"match",refName:y,strand:M*S,syntenyId:l,...C,mate:{start:m,end:u,refName:b,assemblyName:h}}))}s.complete()})}freeResources(){}}U.capabilities=["getFeatures","getRefNames"];export{U as default};
//# sourceMappingURL=BlastTabularAdapter-D8T3WaHb.js.map
