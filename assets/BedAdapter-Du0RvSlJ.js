import{I as D}from"./main-BPWpXae6.js";import{B as F,f as C}from"./util-DreLZf5p.js";import{B as y,i as x,O as B}from"./index-BjO4yXzc.js";import{aH as g}from"./index-CGKDrrCR.js";class I extends y.BaseFeatureDataAdapter{constructor(){super(...arguments),this.intervalTrees={}}async loadDataP(e={}){const t=this.pluginManager,i=this.getConf("bedLocation"),s=await g.fetchAndMaybeUnzip(x.openLocation(i,t),e);if(s.length>536870888)throw new Error("Data exceeds maximum string length (512MB)");const n=new TextDecoder("utf8",{fatal:!0}).decode(s).split(/\n|\r\n|\r/).filter(f=>!!f),o=[];let a=0;for(;a<n.length&&n[a].startsWith("#");a++)o.push(n[a]);const d=o.join(`
`),c={};for(;a<n.length;a++){const f=n[a],b=f.indexOf("	"),p=f.slice(0,b);c[p]||(c[p]=[]),c[p].push(f)}const l=this.getConf("autoSql"),h=new F({autoSql:l}),m=this.getConf("columnNames"),u=this.getConf("scoreColumn"),v=this.getConf("colRef"),w=this.getConf("colStart"),T=this.getConf("colEnd");return{header:d,features:c,parser:h,columnNames:m,scoreColumn:u,colRef:v,colStart:w,colEnd:T}}async loadData(e={}){return this.bedFeatures||(this.bedFeatures=this.loadDataP(e).catch(t=>{throw this.bedFeatures=void 0,t})),this.bedFeatures}async getRefNames(e={}){const{features:t}=await this.loadData(e);return Object.keys(t)}async getHeader(e={}){const{header:t}=await this.loadData(e);return t}async getNames(){const{header:e,columnNames:t}=await this.loadData();if(t.length)return t;const s=e.split(/\n|\r\n|\r/).filter(r=>!!r).at(-1);return s!=null&&s.includes("	")?s.slice(1).split("	").map(r=>r.trim()):void 0}async loadFeatureIntervalTreeHelper(e){const{colRef:t,colStart:i,colEnd:s,features:r,parser:n,scoreColumn:o}=await this.loadData(),a=r[e];if(!a)return;const d=await this.getNames(),c=new D;for(let l=0;l<a.length;l++){const h=a[l],m=`${this.id}-${e}-${l}`,u=new g.SimpleFeature(C({line:h,colRef:t,colStart:i,colEnd:s,scoreColumn:o,parser:n,uniqueId:m,names:d}));c.insert([u.get("start"),u.get("end")],u)}return c}async loadFeatureIntervalTree(e){return this.intervalTrees[e]||(this.intervalTrees[e]=this.loadFeatureIntervalTreeHelper(e).catch(t=>{throw this.intervalTrees[e]=void 0,t})),this.intervalTrees[e]}getFeatures(e,t={}){return B(async i=>{const{start:s,end:r,refName:n}=e,o=await this.loadFeatureIntervalTree(n),a=o==null?void 0:o.search([s,r]);if(a)for(const d of a)i.next(d);i.complete()},t.stopToken)}freeResources(){}}I.capabilities=["getFeatures","getRefNames"];export{I as default};
//# sourceMappingURL=BedAdapter-Du0RvSlJ.js.map
