import{T as I}from"./tabixIndexedFile-T3umufOs.js";import"./unzip-D5O2z_dA.js";import{B as S}from"./index-7uUUtqbY.js";import{ah as g,u as h,aB as F}from"./index-BXtJZUZx.js";import{r as T}from"./rxjs-B_16j8uU.js";import{S as C}from"./simpleFeature-DfRACQ8D.js";import{p as L,f as N}from"./featureData-XuIg4mRh.js";import"./AbortablePromiseCache-Bzbqdtb1.js";import"./browser-DdKr-yeI.js";import"./remoteFile-CmdsMkYh.js";import"./index-COaqUQYE.js";class j extends S.BaseFeatureDataAdapter{async configurePre(t){const e=this.getConf("gffGzLocation"),s=this.getConf(["index","indexType"]),n=this.getConf(["index","location"]),f=this.getConf("dontRedispatch"),c=new I({filehandle:g.openLocation(e,this.pluginManager),csiFilehandle:s==="CSI"?g.openLocation(n,this.pluginManager):void 0,tbiFilehandle:s!=="CSI"?g.openLocation(n,this.pluginManager):void 0,chunkCacheSize:50*2**20,renameRefSeqs:d=>d});return{gff:c,dontRedispatch:f,header:await c.getHeader()}}async configurePre2(){return this.configured||(this.configured=this.configurePre().catch(t=>{throw this.configured=void 0,t})),this.configured}async configure(t){const{statusCallback:e=()=>{}}=t||{};return h.updateStatus("Downloading index",e,()=>this.configurePre2())}async getRefNames(t={}){const{gff:e}=await this.configure(t);return e.getReferenceSequenceNames(t)}async getHeader(t={}){const{gff:e}=await this.configure(t);return e.getHeader()}getFeatures(t,e={}){return T.ObservableCreate(async s=>{const{gff:n}=await this.configure(e),f=await n.getMetadata();await this.getFeaturesHelper(t,e,f,s,!0)},e.stopToken)}async getFeaturesHelper(t,e,s,n,f,c=t){var d,u;const{statusCallback:p=()=>{}}=e;try{const o=[],{dontRedispatch:m,gff:x}=await this.configure(e);if(await h.updateStatus("Downloading features",p,()=>x.getLines(t.refName,t.start,t.end,(a,i)=>{o.push(this.parseLine(s.columnNumbers,a,i))})),f&&o.length){let a=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(const r of o){const H=r.fields[2];if(!m.includes(H)){const l=r.start-1;l<a&&(a=l),r.end>i&&(i=r.end)}}if(i>t.end||a<t.start){await this.getFeaturesHelper({...t,start:a,end:i},e,s,n,!1,t);return}}const w=o.map(a=>(a.fields[8]&&a.fields[8]!=="."?a.fields[8].includes("_lineHash")||(a.fields[8]+=`;_lineHash=${a.lineHash}`):a.fields[8]=`_lineHash=${a.lineHash}`,a.fields.join("	"))).join(`
`);for(const a of L(w))for(const i of a){const r=new C({data:N(i),id:`${this.id}-offset-${(u=(d=i.attributes)===null||d===void 0?void 0:d._lineHash)===null||u===void 0?void 0:u[0]}`});F.doesIntersect2(r.get("start"),r.get("end"),c.start,c.end)&&n.next(r)}n.complete()}catch(o){n.error(o)}}parseLine(t,e,s){const n=e.split("	");return{start:+n[t.start-1],end:+n[t.end-1],lineHash:s,fields:n}}}export{j as default};
//# sourceMappingURL=Gff3TabixAdapter-Cs0GRHcH.js.map
