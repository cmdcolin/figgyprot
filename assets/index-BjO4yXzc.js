import{fh as B,bN as b,fi as J,fj as K,fk as N,am as E,an as q,cf as x,az as X,fl as L,fm as Y,fn as Z,fo as ee}from"./index-CGKDrrCR.js";var te={},_={};Object.defineProperty(_,"__esModule",{value:!0});_.isSequenceAdapter=re;_.isRegionsAdapter=ae;_.isFeatureAdapter=ne;_.isRefNameAliasAdapter=se;_.isTextSearchAdapter=ie;function re(n){return"getRegions"in n&&"getFeatures"in n}function ae(n){return"getRegions"in n}function ne(n){return"getFeatures"in n}function se(n){return"getRefNameAliases"in n}function ie(n){return"searchIndex"in n}var z={};Object.defineProperty(z,"__esModule",{value:!0});var C={},P={};Object.defineProperty(P,"__esModule",{value:!0});P.default=oe;const I=B();function oe(n,e="",t=5e3){const r=[n];for(;r.length;){const a=r.pop();for(const[i,s]of Object.entries(a)){if(e.length>t)return(0,I.hashCode)(e);typeof s=="object"&&s!==null?r.push(s):e+=`${i}-${s}`}}return`adp-${(0,I.hashCode)(e)}`}var ce=b&&b.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(C,"__esModule",{value:!0});C.BaseAdapter=void 0;const O=K,U=J(),ue=ce(P),fe=(0,U.ConfigurationSchema)("empty",{});class W{constructor(e=fe.create(),t,r){if(this.config=e,this.getSubAdapter=t,this.pluginManager=r,typeof jest>"u"){const a=(0,O.isStateTreeNode)(e)?(0,O.getSnapshot)(e):e;this.id=`${(0,ue.default)(a)}`}else this.id="test"}getConf(e){return(0,U.readConfObject)(this.config,e)}}C.BaseAdapter=W;W.capabilities=[];var F={},j={};Object.defineProperty(j,"__esModule",{value:!0});var qe=j.ObservableCreate=le;const he=E,de=N;function le(n,e){return(0,de.checkStopToken)(e),new he.Observable(t=>{try{const r=n(t);r!=null&&r.catch&&r.catch(a=>{t.error(a)})}catch(r){t.error(r)}})}var A={};Object.defineProperty(A,"__esModule",{value:!0});A.calcStdFromSums=Q;A.rectifyStats=H;A.scoresToStats=pe;A.blankStats=V;const ge=E,me=q;function Q(n,e,t,r=!1){if(t===0)return 0;let a;return r?a=e/t-n*n/(t*t):(a=e-n*n/t,t>1&&(a/=t-1)),a<0?0:Math.sqrt(a)}function H(n){return{...n,scoreMean:(n.scoreSum||0)/(n.featureCount||n.basesCovered||1),scoreStdDev:Q(n.scoreSum,n.scoreSumSquares,n.featureCount||n.basesCovered),featureDensity:(n.featureCount||1)/n.basesCovered}}async function pe(n,e){const{start:t,end:r}=n,a={scoreMin:Number.MAX_VALUE,scoreMax:Number.MIN_VALUE,scoreSum:0,scoreSumSquares:0,featureCount:0};let i=!1;const{scoreMin:s,scoreMax:o,scoreSum:c,scoreSumSquares:h,featureCount:u}=await(0,ge.firstValueFrom)(e.pipe((0,me.reduce)((d,g)=>{const m=g.get("score"),v=g.get("summary"),{scoreMax:R,scoreMin:f}=d;return d.scoreMax=Math.max(R,v?g.get("maxScore"):m),d.scoreMin=Math.min(f,v?g.get("minScore"):m),d.scoreSum+=m,d.scoreSumSquares+=m*m,d.featureCount+=1,i=!0,d},a)));return i?H({scoreMax:o,scoreMin:s,scoreSum:c,scoreSumSquares:h,featureCount:u,basesCovered:r-t+1}):V()}function V(){return{scoreMin:0,scoreMax:0,scoreMean:0,scoreStdDev:0,scoreSum:0,scoreSumSquares:0,featureCount:0,featureDensity:0,basesCovered:0}}Object.defineProperty(F,"__esModule",{value:!0});F.BaseFeatureDataAdapter=void 0;const M=E,k=q,be=C,y=B(),_e=j,T=A,Se=N;class ye extends be.BaseAdapter{async getHeader(e){return null}async getMetadata(e){return null}getFeaturesInRegion(e,t={}){return(0,_e.ObservableCreate)(async r=>{const a=await this.hasDataForRefName(e.refName,t);(0,Se.checkStopToken)(t.stopToken),a?this.getFeatures(e,t).subscribe(r):r.complete()})}getFeaturesInMultipleRegions(e,t={}){return(0,M.merge)(...e.map(r=>this.getFeaturesInRegion(r,t)))}async hasDataForRefName(e,t={}){return(await this.getRefNames(t)).includes(e)}async getRegionQuantitativeStats(e,t){const r=this.getFeatures(e,t);return(0,T.scoresToStats)(e,r)}async getMultiRegionQuantitativeStats(e=[],t){if(!e.length)return(0,T.blankStats)();const r=await Promise.all(e.map(u=>this.getRegionQuantitativeStats(u,t))),a=(0,y.max)(r.map(u=>u.scoreMax)),i=(0,y.min)(r.map(u=>u.scoreMin)),s=(0,y.sum)(r.map(u=>u.scoreSum)),o=(0,y.sum)(r.map(u=>u.scoreSumSquares)),c=(0,y.sum)(r.map(u=>u.featureCount)),h=(0,y.sum)(r.map(u=>u.basesCovered));return(0,T.rectifyStats)({scoreMin:i,scoreMax:a,featureCount:c,basesCovered:h,scoreSumSquares:o,scoreSum:s})}getRegionFeatureDensityStats(e,t){let r=+Date.now();const a=async(s,o)=>{const{start:c,end:h}=e,u=c*.75+h*.25,d=await(0,M.firstValueFrom)(this.getFeatures({...e,start:Math.max(0,Math.round(u-s/2)),end:Math.min(Math.round(u+s/2),h)},t).pipe((0,k.toArray)()));return i({interval:s,statsSampleFeatures:d.length,expansionTime:o,stats:{featureDensity:d.length/s}})},i=async({interval:s,stats:o,statsSampleFeatures:c,expansionTime:h})=>{const u=e.end-e.start;if(c>=70||s*2>u)return o;if(h<=5e3){const d=+Date.now();return h+=d-r,r=d,a(s*2,h)}else return console.warn("Stats estimation reached timeout, or didn't get enough features"),{featureDensity:Number.POSITIVE_INFINITY}};return a(1e3,0)}async getMultiRegionFeatureDensityStats(e,t){if(!e.length)throw new Error("No regions supplied");return this.getRegionFeatureDensityStats(e[0],t)}async getSources(e){const t=await(0,M.firstValueFrom)(this.getFeaturesInMultipleRegions(e).pipe((0,k.toArray)())),r=new Set;for(const a of t)r.add(a.get("source"));return[...r].map(a=>({name:a}))}}F.BaseFeatureDataAdapter=ye;var D={};Object.defineProperty(D,"__esModule",{value:!0});D.BaseSequenceAdapter=void 0;const we=F;class Ae extends we.BaseFeatureDataAdapter{async getMultiRegionFeatureDensityStats(){return{featureDensity:0}}}D.BaseSequenceAdapter=Ae;(function(n){var e=b&&b.__createBinding||(Object.create?function(s,o,c,h){h===void 0&&(h=c);var u=Object.getOwnPropertyDescriptor(o,c);(!u||("get"in u?!o.__esModule:u.writable||u.configurable))&&(u={enumerable:!0,get:function(){return o[c]}}),Object.defineProperty(s,h,u)}:function(s,o,c,h){h===void 0&&(h=c),s[h]=o[c]}),t=b&&b.__exportStar||function(s,o){for(var c in s)c!=="default"&&!Object.prototype.hasOwnProperty.call(o,c)&&e(o,s,c)};Object.defineProperty(n,"__esModule",{value:!0}),n.BaseSequenceAdapter=n.BaseFeatureDataAdapter=n.BaseAdapter=void 0,t(_,n),t(z,n);var r=C;Object.defineProperty(n,"BaseAdapter",{enumerable:!0,get:function(){return r.BaseAdapter}});var a=F;Object.defineProperty(n,"BaseFeatureDataAdapter",{enumerable:!0,get:function(){return a.BaseFeatureDataAdapter}});var i=D;Object.defineProperty(n,"BaseSequenceAdapter",{enumerable:!0,get:function(){return i.BaseSequenceAdapter}})})(te);var ve={},w={};function Ce(n){if(typeof n!="string")return{};const e={};return n.toLowerCase().replace(/(?:^|(?:\s*,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,a,i,s)=>{const o=i||s;return e[a]=o?o.toLowerCase():!0,""})?{}:(Object.keys(e).forEach(r=>{if(/^[\d]+$/.test(`${e[r]}`))try{const a=parseInt(`${e[r]}`,10);Number.isNaN(a)||(e[r]=a)}catch{}}),e)}class Fe{constructor({minimumTTL:e}){this.minimumTTL=e}calculateChunkExpirationDate(e){const{headers:t={},requestDate:r,responseDate:a}=e,{date:i,pragma:s}=t;let o=a||r;if(!o){if(!i)return;o=new Date(i)}const c=u=>new Date(o.getTime()+u);if(/\bno-cache\b/.test(s||""))return c(this.minimumTTL);const h=Ce(t["cache-control"]||"");if(h["no-cache"]||h["no-store"]||h["must-revalidate"])return c(this.minimumTTL);if(h["max-age"]!==void 0){const u=+h["max-age"]*1e3;return c(Math.max(u,this.minimumTTL))}else{if(this._coerceToDate(t.expires))return this._coerceToDate(t.expires);if(this._coerceToDate(t["last-modified"])){const u=this._coerceToDate(t["last-modified"]),d=(o.getTime()-((u==null?void 0:u.getTime())||0))/10;return c(d)}}}_coerceToDate(e){if(e){if(e instanceof Date)return e;if(typeof e=="string"||typeof e=="number")return new Date(e)}}cachedChunkIsValid(e){const t=this.calculateChunkExpirationDate(e);return!t||new Date<=t}chunkIsCacheable(e){return!0}}class De{constructor({fetch:e,frequency:t=100,maxExtraSize:r=32e3,maxFetchSize:a=1e6}){this.requestQueues={},this.fetchCallback=e,this.frequency=t,this.maxExtraSize=r,this.maxFetchSize=a}_canAggregate(e,t){return t.start<=e.end+this.maxExtraSize&&t.end-t.start+e.end-e.start<this.maxFetchSize}_allSignalsFired(e){return new Promise(t=>{let r=e.filter(a=>!a.aborted).length;e.forEach(a=>{a.addEventListener("abort",()=>{r-=1,r||t()})})}).catch(t=>{console.error(t)})}_dispatch({url:e,start:t,end:r,requests:a}){const i=new AbortController,s=[];a.forEach(({requestOptions:o})=>{o.signal&&s.push(o.signal)}),s.length===a.length&&this._allSignalsFired(s).then(()=>{i.abort()}),this.fetchCallback(e,t,r-1,{signal:i.signal}).then(o=>{const c=o.buffer;a.forEach(({start:h,end:u,resolve:d})=>{d({headers:o.headers,buffer:c.subarray(h-t,u-t)})})}).catch(o=>{a.forEach(({reject:c})=>{c(o)})})}_aggregateAndDispatch(){Object.entries(this.requestQueues).forEach(([e,t])=>{if(!t.length)return;const r=[];if(t.forEach(i=>{var c;const{requestOptions:s,reject:o}=i;(c=s.signal)!=null&&c.aborted?o(Object.assign(new Error("aborted"),{code:"ERR_ABORTED"})):r.push(i)}),r.sort((i,s)=>i.start-s.start),t.length=0,!r.length)return;let a;for(const i of r)a&&this._canAggregate(a,i)?(a.requests.push(i),a.end=i.end):(a&&this._dispatch(a),a={requests:[i],url:e,start:i.start,end:i.end});a&&this._dispatch(a)})}_enQueue(e,t){this.requestQueues[e]||(this.requestQueues[e]=[]),this.requestQueues[e].push(t)}fetch(e,t,r,a={}){return new Promise((i,s)=>{this._enQueue(e,{start:t,end:r,resolve:i,reject:s,requestOptions:a}),this.timeout||(this.timeout=setTimeout(()=>{this.timeout=void 0,this._aggregateAndDispatch()},this.frequency||1))})}}async function Re(n,e,t,r={}){const a=new Date,i=Object.assign({method:"GET",headers:{range:`bytes=${e}-${t}`}},r),s=await fetch(n,i),o=new Date;if(s.status!==206&&s.status!==200)throw new Error(`HTTP ${s.status} when fetching ${n} bytes ${e}-${t}`);if(s.status===200)throw new Error(`HTTP ${s.status} when fetching ${n} bytes ${e}-${t}`);const c=new Uint8Array(await s.arrayBuffer());return{headers:s.headers.map,requestDate:a,responseDate:o,buffer:c}}function Me(n){let e=0;for(const t of n)e+=t.length;return e}function Te(n){const e=new Uint8Array(Me(n));let t=0;for(const r of n)e.set(r,t),t+=r.length;return e}function $e(n){return n.name==="AbortError"||n.code==="ERR_ABORTED"||!!n.message.match(/\b(aborted|AbortError)\b/i)}class Be{constructor({fetch:e=Re,size:t=1e7,chunkSize:r=32768,aggregationTime:a=100,minimumTTL:i=1e3,maxFetchSize:s=r*4,maxExtraFetch:o=r}){this.aggregator=new De({fetch:e,frequency:a,maxFetchSize:s,maxExtraSize:o}),this.chunkSize=r,this.chunkCache=new x({maxSize:Math.floor(t/r)||1}),this.cacheSemantics=new Fe({minimumTTL:i}),this.stats=new x({maxSize:20})}async getRange(e,t,r,a={}){const i=Math.floor(t/this.chunkSize),s=Math.floor((t+r-1)/this.chunkSize),o=new Array(s-i+1);for(let u=i;u<=s;u+=1)o[u-i]=this._getChunk(e,u,a).then(d=>d&&{headers:d.headers,buffer:d.buffer,chunkNumber:u});let c=await Promise.all(o);if(c=c.filter(u=>!!u),!c.length)return{headers:{},buffer:new Uint8Array(0)};const h=t-c[0].chunkNumber*this.chunkSize;return{headers:this._makeHeaders(c[0].headers,t,t+r-1),buffer:this._makeBuffer(c,h,r)}}_makeBuffer(e,t,r){if(e.length===1)return e[0].buffer.slice(t,t+r);if(e.length===0)return new Uint8Array(0);{const a=e.map(c=>c.buffer),i=a.shift().slice(t);let s=a.pop(),o=i.length+a.reduce((c,h)=>c+h.length,0)+s.length-r;return o<0&&(o=0),s=s.slice(0,s.length-o),Te([i,...a,s])}}async stat(e){let t=this.stats.get(e);if(!t){const r=await this._getChunk(e,0);if(r&&this._recordStatsIfNecessary(e,r),t=this.stats.get(e),!t)throw new Error(`failed to retrieve file size for ${e}`)}return t}_headersToStats(e){const{headers:t}=e,r={};if(t!=null&&t["content-range"]){const a=/\d+-\d+\/(\d+)/.exec(t["content-range"]);if(a){const i=parseInt(a[1],10);Number.isNaN(i)||(r.size=i)}}return t!=null&&t["last-modified"]&&(r.mtime=new Date(t["last-modified"]),r.mtime.toString()==="Invalid Date"&&(console.warn("Invalid Date"),r.mtime=new Date),r.mtimeMs=r.mtime.getTime()),r}_makeHeaders(e,t,r){const a={...e},i=/\d+-\d+\/(\d+)/.exec(a["content-range"]||"");return{...e,"content-length":r-t,"content-range":`${t}-${r-1}/${i==null?void 0:i[1]}`,"x-resource-length":i==null?void 0:i[1]}}async _getChunk(e,t,r){const a=`${e}/${t}`,i=this.chunkCache.get(a);if(i){let d,g=!1;try{d=await i}catch(m){if($e(m))g=!0;else throw m}return d&&(g||!this.cacheSemantics.cachedChunkIsValid(d))?(this._uncacheIfSame(a,i),this._getChunk(e,t,r)):(d&&this._recordStatsIfNecessary(e,d),d)}const s=t*this.chunkSize;let o=s+this.chunkSize;const c=this.stats.get(e);if(c!=null&&c.size){if(s>=c.size)return;o>=c.size&&(o=c.size)}const h=this.aggregator.fetch(e,s,o,r).catch(d=>{throw this._uncacheIfSame(a,h),d});this.chunkCache.set(a,h);const u=await h;return this._recordStatsIfNecessary(e,u),this.cacheSemantics.chunkIsCacheable(u)||this._uncacheIfSame(a,h),u}_recordStatsIfNecessary(e,t){this.stats.has(e)||this.stats.set(e,this._headersToStats(t))}_uncacheIfSame(e,t){this.chunkCache.get(e)===t&&this.chunkCache.delete(e)}reset(){this.stats.clear(),this.chunkCache.clear()}}const Ee=Object.freeze(Object.defineProperty({__proto__:null,HttpRangeFetcher:Be},Symbol.toStringTag,{value:"Module"})),Pe=X(Ee);Object.defineProperty(w,"__esModule",{value:!0});w.RemoteFileWithRangeCache=void 0;w.clearCache=Oe;const je=Pe,xe=L,$={};function Ie(n,e,t,r={}){const a=$[n];if(!a)throw new Error(`fetch not registered for ${n}`);return a(n,e,t,r)}const G=new je.HttpRangeFetcher({fetch:Ie,size:500*1024**2,chunkSize:128*1024,maxFetchSize:100*1024**2,minimumTTL:24*60*60*1e3});function Oe(){G.reset()}class ke extends xe.RemoteFile{async fetch(e,t){const r=String(e);$[r]||($[r]=this.fetchBinaryRange.bind(this));const a=new Headers(t==null?void 0:t.headers).get("range");if(a){const i=/bytes=(\d+)-(\d+)/.exec(a);if(i){const[,s,o]=i,c=Number.parseInt(s,10),u=Number.parseInt(o,10)-c,{buffer:d,headers:g}=await G.getRange(`${e}`,c,u+1);return new Response(d,{status:206,headers:g})}}return super.fetch(e,t)}async fetchBinaryRange(e,t,r,a={}){const i=new Date,s=await super.fetch(e,{...a,headers:{...a.headers,range:`bytes=${t}-${r}`}}),o=new Date;if(!s.ok){const u=`HTTP ${s.status} fetching ${e} bytes ${t}-${r}`,d=" (should be 206 for range requests)";throw new Error(`${u}${s.status===200?d:""}`)}const c={};for(const[u,d]of s.headers.entries())c[u]=d;const h=await s.arrayBuffer();return{headers:c,requestDate:i,responseDate:o,buffer:new Uint8Array(h)}}}w.RemoteFileWithRangeCache=ke;(function(n){var e=b&&b.__importDefault||function(f){return f&&f.__esModule?f:{default:f}};Object.defineProperty(n,"__esModule",{value:!0}),n.RemoteFileWithRangeCache=void 0,n.resolveUriLocation=u,n.openLocation=d,n.getFetcher=g;const t=e(Y),r=L,a=w,i=B(),s=ee,o=Z();function c(f){return"localPath"in f}function h(f){return"blobId"in f}function u(f){return f.baseUri?{...f,uri:new URL(f.uri,f.baseUri).href}:f}function d(f,p){if(c(f)){if(!f.localPath)throw new Error("No local path provided");if(t.default||i.isElectron)return new r.LocalFile(f.localPath);throw new Error("can't use local files in the browser")}if(h(f)){const l=(0,s.getBlob)(f.blobId);if(!l)throw new Error(`file ("${f.name}") was opened locally from a previous session. To restore it, go to track settings and reopen the file`);return new r.BlobFile(l)}if((0,o.isUriLocation)(f)){if(!f.uri)throw new Error("No URI provided");const l=u(f);if(p){const S=m(f,p);if(S)return S.openLocation(l)}return new a.RemoteFileWithRangeCache(l.uri,{fetch:v})}throw new Error("invalid fileLocation")}function g(f,p){if(!(0,o.isUriLocation)(f))throw new Error(`Not a valid UriLocation: ${JSON.stringify(f)}`);if(p){const l=m(f,p);if(l)return l.getFetcher(f)}return v}function m(f,p){const{rootModel:l}=p;if(l&&(0,o.isRootModelWithInternetAccounts)(l))return l.findAppropriateInternetAccount(f);if(f.internetAccountPreAuthorization){if(!f.internetAccountPreAuthorization.authInfo.token)throw new Error("Failed to obtain token from internet account. Try reloading the page");return p.getInternetAccountType(f.internetAccountPreAuthorization.internetAccountType).stateModel.create({type:f.internetAccountPreAuthorization.internetAccountType,configuration:f.internetAccountPreAuthorization.authInfo.configuration})}}async function v(f,p){var l;const S=await fetch(f,p);if(S.status===401&&(!((l=S.headers.get("WWW-Authenticate"))===null||l===void 0)&&l.includes("Basic")))throw new o.AuthNeededError("Accessing HTTPBasic resource without authentication",f.toString());return S}var R=w;Object.defineProperty(n,"RemoteFileWithRangeCache",{enumerable:!0,get:function(){return R.RemoteFileWithRangeCache}})})(ve);export{te as B,qe as O,ve as i};
//# sourceMappingURL=index-BjO4yXzc.js.map
