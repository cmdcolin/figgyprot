import{B as R}from"./bbi-DdUBGRmD.js";import{ce as T,cf as z,am as x,an as U,aH as k}from"./index-CGKDrrCR.js";import{B as H,a as $}from"./util-DreLZf5p.js";import{B as j,i as L,O as G}from"./index-BjO4yXzc.js";function J(C){return C.filter(e=>!!e)}class M extends R{constructor(){super(...arguments),this.readIndicesCache=new T({cache:new z({maxSize:1}),fill:(e,t)=>this._readIndices({...e,signal:t})})}readIndices(e={}){const{signal:t,...a}=e;return this.readIndicesCache.get(JSON.stringify(a),e,t)}async getView(e,t){return this.getUnzoomedView(t)}async _readIndices(e){const{extHeaderOffset:t}=await this.getHeader(e),a=await this.bbi.read(64,Number(t)),s=new DataView(a.buffer,a.byteOffset,a.length);let c=0;c+=2;const m=s.getUint16(c,!0);c+=2;const u=Number(s.getBigUint64(c,!0));if(c+=8,m===0)return[];const i=20,d=i*m,y=await this.bbi.read(d,Number(u)),g=[];for(let b=0;b<m;b+=1){const l=y.subarray(b*i),r=new DataView(l.buffer,l.byteOffset,l.length);let n=0;const h=r.getInt16(n,!0);n+=2;const f=r.getInt16(n,!0);n+=2;const p=Number(r.getBigUint64(n,!0));n+=12;const O=r.getInt16(n,!0);g.push({type:h,fieldcount:f,offset:Number(p),field:O})}return g}async searchExtraIndexBlocks(e,t={}){const a=await this.readIndices(t);if(a.length===0)return[];const s=new TextDecoder("utf8"),c=a.map(async m=>{const{offset:u,field:i}=m,d=await this.bbi.read(32,u,t),y=new DataView(d.buffer,d.byteOffset,d.length);let g=0;g+=4;const b=y.getInt32(g,!0);g+=4;const l=y.getInt32(g,!0);g+=4;const r=y.getInt32(g,!0);g+=4,g+=8;const n=async f=>{const p=Number(f),O=4+b*(l+r),S=await this.bbi.read(O,p,t),N=new DataView(S.buffer,S.byteOffset,S.length);let o=0;const v=N.getInt8(o);o+=2;const D=N.getInt16(o,!0);o+=2;const P=[];if(v===0){const I=[];for(let F=0;F<D;F++){const E=s.decode(S.subarray(o,o+l)).replaceAll("\0","");o+=l;const V=Number(N.getBigUint64(o,!0));o+=8,I.push({key:E,offset:V})}let B=0;for(const{key:F,offset:E}of I){if(e.localeCompare(F)<0&&B)return n(B);B=E}return n(B)}else if(v===1){for(let I=0;I<D;I++){const B=s.decode(S.subarray(o,o+l)).replaceAll("\0","");o+=l;const F=Number(N.getBigUint64(o,!0));o+=8;const E=N.getUint32(o,!0);o+=4;const V=N.getUint32(o,!0);o+=4,P.push({key:B,offset:F,length:E,reserved:V})}for(const I of P)if(I.key===e)return{...I,field:i};return}};return n(u+32)});return J(await Promise.all(c))}async searchExtraIndex(e,t={}){const a=await this.searchExtraIndexBlocks(e,t);if(a.length===0)return[];const s=await this.getUnzoomedView(t),c=a.map(u=>new x.Observable(i=>{s.readFeatures(i,[u],t).catch(d=>{i.error(d)})}).pipe(U.reduce((i,d)=>i.concat(d)),U.map(i=>{for(const d of i)d.field=u.field;return i})));return(await x.firstValueFrom(x.merge(...c))).filter(u=>{var i;return((i=u.rest)==null?void 0:i.split("	")[(u.field||0)-3])===e})}}class W extends j.BaseFeatureDataAdapter{async configurePre(e){const t=this.pluginManager,a=new M({filehandle:L.openLocation(this.getConf("bigBedLocation"),t)}),s=await a.getHeader(e),c=new H({autoSql:s.autoSql});return{bigbed:a,header:s,parser:c}}async configure(e){return this.cachedP||(this.cachedP=this.configurePre(e).catch(t=>{throw this.cachedP=void 0,t})),this.cachedP}async getRefNames(e){const{header:t}=await this.configure(e);return Object.keys(t.refsByName)}async getRefNameAliases(e){const{header:t}=await this.configure(e);return(await Promise.all(Object.keys(t.refsByName).map(async s=>(await x.firstValueFrom(this.getFeatures({assemblyName:"",refName:s,start:0,end:1}).pipe(x.toArray())))[0]))).map(s=>s.toJSON()).map(s=>({refName:s.ucsc,aliases:[s.ncbi,s.refseq,s.genbank],override:!0}))}async getData(){const e=await this.getRefNames(),t=[];for(const a of e){const s=await x.firstValueFrom(this.getFeatures({assemblyName:"unknown",refName:a,start:0,end:Number.MAX_SAFE_INTEGER}).pipe(x.toArray()));t.push(s)}return t.flat()}async getHeader(e){const{parser:t,header:a}=await this.configure(e),{version:s,fileType:c}=a,{fields:m,...u}=t.autoSql;return{version:s,fileType:c,autoSql:{...u},fields:Object.fromEntries(m.map(({name:i,comment:d})=>[i,d]))}}async getFeaturesHelper({query:e,opts:t,observer:a,allowRedispatch:s,originalQuery:c=e}){var m;const{statusCallback:u=()=>{}}=t,i=this.getConf("scoreColumn"),d=this.getConf("aggregateField"),{parser:y,bigbed:g}=await k.updateStatus("Downloading header",u,()=>this.configure(t)),b=await k.updateStatus("Downloading features",u,()=>g.getFeatures(e.refName,e.start,e.end,{basesPerSpan:e.end-e.start}));if(s&&b.length){let r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,h=!1;for(const f of b)f.start<r&&(r=f.start),f.end>n&&(n=f.end),f[d]&&(h=!0);if(h&&(n>e.end||r<e.start)){await this.getFeaturesHelper({query:{...e,start:r-5e5,end:n+5e5},opts:t,observer:a,allowRedispatch:!1,originalQuery:e});return}}const l={};if(b.some(r=>r.uniqueId===void 0))throw new Error("found uniqueId undefined");for(const r of b){const n=[e.refName,`${r.start}`,`${r.end}`,...((m=r.rest)===null||m===void 0?void 0:m.split("	"))||[]],h=y.parseLine(n,{uniqueId:r.uniqueId}),f=h[d];l[f]||(l[f]=[]);const{uniqueId:p,type:O,chrom:w,chromStart:S,chromEnd:N,description:o,chromStarts:v,blockStarts:D,blockSizes:P,score:I,blockCount:B,thickStart:F,thickEnd:E,strand:V,..._}=h,A=$({..._,scoreColumn:i,splitLine:n,parser:y,uniqueId:p,start:r.start,end:r.end,refName:e.refName});f?l[f].push(A):k.doesIntersect2(A.start,A.end,c.start,c.end)&&a.next(new k.SimpleFeature({id:`${this.id}-${p}`,data:A}))}Object.entries(l).map(([r,n])=>{var h,f;const p=k.min(n.map(w=>w.start)),O=k.max(n.map(w=>w.end));if(k.doesIntersect2(p,O,c.start,c.end)){const w=n.sort((S,N)=>S.uniqueId.localeCompare(N.uniqueId));a.next(new k.SimpleFeature({id:`${this.id}-${(h=w[0])===null||h===void 0?void 0:h.uniqueId}-parent`,data:{type:"gene",subfeatures:w,strand:((f=w[0])===null||f===void 0?void 0:f.strand)||1,name:r,start:p,end:O,refName:e.refName}}))}}),a.complete()}getFeatures(e,t={}){return G(async a=>{try{await this.getFeaturesHelper({query:{...e,start:e.start,end:e.end},opts:t,observer:a,allowRedispatch:!0})}catch(s){a.error(s)}},t.stopToken)}freeResources(){}}export{W as default};
//# sourceMappingURL=BigBedAdapter-NY3qVlPX.js.map
