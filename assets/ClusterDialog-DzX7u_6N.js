import{o as E,c as o,J as l,j as e,D as W,B as d,T as k,e as T,cK as D,H as S,f as $,X as F,W as q,y as I,m as K,cI as L,cH as N,cL as U,cD as O,h as H,R as _}from"./index-CGKDrrCR.js";const X=E(function({model:t,children:i,handleClose:r}){const[c,p]=o.useState(""),[x,u]=o.useState(),[h,v]=o.useState(""),[g,M]=o.useState(!1),[f,m]=l.useLocalStorage("cluster-samplesPerPixel","1");return e.jsxs(e.Fragment,{children:[e.jsxs(W,{children:[i,e.jsxs("div",{style:{marginTop:50},children:[e.jsx(d,{variant:"contained",onClick:()=>{M(!g)},children:g?"Hide advanced options":"Show advanced options"}),g?e.jsxs("div",{style:{marginTop:20},children:[e.jsx(k,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(T,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:f,onChange:a=>{m(a.target.value)}})]}):null]}),e.jsxs("div",{children:[c?e.jsxs("div",{style:{padding:50},children:[e.jsxs("span",{style:{width:400},children:["Progress: ",c]}),e.jsx(d,{onClick:()=>{D(h)},children:"Stop"})]}):null,x?e.jsx(S.ErrorMessage,{error:x}):null]})]}),e.jsxs($,{children:[e.jsx(d,{variant:"contained",onClick:async()=>{try{u(void 0),p("");const a=l.getContainingView(t);if(!a.initialized)return;const{rpcManager:C}=l.getSession(t),{sourcesWithoutLayout:y,adapterConfig:b}=t;if(y){const w=F.getRpcSessionId(t),j=q();v(j);const A=await C.call(w,"MultiWiggleClusterScoreMatrix",{regions:a.dynamicBlocks.contentBlocks,sources:y,sessionId:w,adapterConfig:b,stopToken:j,bpPerPx:a.bpPerPx/+f,statusCallback:s=>{p(s)}});t.setLayout(A.order.map(s=>{const n=y[s];if(!n)throw new Error(`out of bounds at ${s}`);return n}))}r()}catch(a){!l.isAbortException(a)&&I(t)&&(console.error(a),u(a))}finally{p(""),v("")}},children:"Run clustering"}),e.jsx(d,{variant:"contained",color:"secondary",onClick:()=>{r(),h&&D(h)},children:"Cancel"})]})]})}),Q=K()(t=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:t.spacing(4)}})),Y=E(function({model:t,handleClose:i,children:r}){const{classes:c}=Q(),[p,x]=o.useState(""),[u,h]=o.useState(),[v,g]=o.useState(),[M,f]=o.useState(!1),[m,a]=o.useState(!1),[C,y]=l.useLocalStorage("cluster-clusterMethod","single"),[b,w]=l.useLocalStorage("cluster-samplesPerPixel","1");o.useEffect(()=>{(async()=>{try{g(void 0),h(void 0),f(!0);const s=l.getContainingView(t),{dynamicBlocks:n,bpPerPx:P}=s,{rpcManager:z}=l.getSession(t),{sourcesWithoutLayout:G,adapterConfig:V}=t,R=F.getRpcSessionId(t),J=await z.call(R,"MultiWiggleGetScoreMatrix",{regions:n.contentBlocks,sources:G,sessionId:R,adapterConfig:V,bpPerPx:P/+b});h(J)}catch(s){!l.isAbortException(s)&&I(t)&&(console.error(s),g(s))}finally{f(!1)}})()},[t,b]);const j=u?`inputMatrix<-matrix(c(${Object.values(u).map(s=>s.join(",")).join(`,
`)}
),nrow=${Object.values(u).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(u).map(s=>`'${s}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${C}')
cat(resultClusters$order,sep='\\n')`:void 0,A=u?Object.entries(u).map(([s,n])=>[s,...n].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs(W,{children:[r,e.jsxs("div",{style:{marginTop:50},children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(d,{variant:"contained",onClick:()=>{L.saveAs(new Blob([j||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(d,{variant:"contained",onClick:()=>{N(j||"")},children:"Copy Rscript to clipboard"})," ",e.jsx("div",{style:{float:"right"},children:e.jsx(S.CascadingMenuButton,{menuItems:[{label:"Download TSV",onClick:()=>{L.saveAs(new Blob([A||""],{type:"text/plain;charset=utf-8"}),"scores.tsv")}},{label:m?"Hide advanced options":"Show advanced options",onClick:()=>{a(!m)}}],children:e.jsx(U,{})})}),e.jsx("div",{children:m?e.jsxs("div",{children:[e.jsx(k,{variant:"h6",children:"Advanced options"}),e.jsx(O,{children:Object.entries({single:"Single",complete:"Complete"}).map(([s,n])=>e.jsx(H,{control:e.jsx(_,{checked:C===s,onChange:()=>{y(s)}}),label:n},s))}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(k,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(T,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:b,onChange:s=>{w(s.target.value)}})]})]}):null}),j?e.jsx("div",{}):M?e.jsx(S.LoadingEllipses,{variant:"h6",title:"Generating score matrix"}):v?e.jsx(S.ErrorMessage,{error:v}):null]}),e.jsxs("div",{children:[e.jsx(k,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(T,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:p,onChange:s=>{x(s.target.value)},slotProps:{input:{classes:{input:c.textAreaFont}}}})]})]})]}),e.jsxs($,{children:[e.jsx(d,{variant:"contained",onClick:()=>{const{sourcesWithoutLayout:s}=t;if(s)try{t.setLayout(p.split(`
`).map(n=>n.trim()).filter(n=>!!n).map(n=>+n).map(n=>{const P=s[n-1];if(!P)throw new Error(`out of bounds at ${n}`);return P}))}catch(n){console.error(n),l.getSession(t).notifyError(`${n}`,n)}i()},children:"Apply clustering"}),e.jsx(d,{variant:"contained",color:"secondary",onClick:()=>{i()},children:"Cancel"})]})]})});function B({activeMode:t,setActiveMode:i}){return e.jsx("div",{children:e.jsx(O,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slow for large data, built in JS clustering)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster for large data, uses hclust, may be more accurate)"})}).map(([r,c])=>e.jsx(H,{control:e.jsx(_,{checked:t===r,onChange:()=>{i(r)}}),label:c},r))})})}const ee=E(function({model:t,handleClose:i}){const[r,c]=o.useState("auto");return e.jsx(S.Dialog,{open:!0,title:"Cluster by score",maxWidth:"xl",onClose:(p,x)=>{x!=="backdropClick"&&i()},children:r==="auto"?e.jsx(X,{model:t,handleClose:i,children:e.jsx(B,{activeMode:r,setActiveMode:c})}):e.jsx(Y,{model:t,handleClose:i,children:e.jsx(B,{activeMode:r,setActiveMode:c})})})});export{ee as default};
//# sourceMappingURL=ClusterDialog-DzX7u_6N.js.map
