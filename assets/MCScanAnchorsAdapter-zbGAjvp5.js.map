{"version":3,"file":"MCScanAnchorsAdapter-zbGAjvp5.js","sources":["../../node_modules/@jbrowse/plugin-comparative-adapters/esm/MCScanAnchorsAdapter/MCScanAnchorsAdapter.js"],"sourcesContent":["import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { SimpleFeature, doesIntersect2 } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport { parseBed, readFile } from '../util';\nclass MCScanAnchorsAdapter extends BaseFeatureDataAdapter {\n    async setup(opts) {\n        if (!this.setupP) {\n            this.setupP = this.setupPre(opts).catch((e) => {\n                this.setupP = undefined;\n                throw e;\n            });\n        }\n        return this.setupP;\n    }\n    async setupPre(opts) {\n        const assemblyNames = this.getConf('assemblyNames');\n        const pm = this.pluginManager;\n        const bed1 = openLocation(this.getConf('bed1Location'), pm);\n        const bed2 = openLocation(this.getConf('bed2Location'), pm);\n        const mcscan = openLocation(this.getConf('mcscanAnchorsLocation'), pm);\n        const [bed1text, bed2text, mcscantext] = await Promise.all([bed1, bed2, mcscan].map(r => readFile(r, opts)));\n        const bed1Map = parseBed(bed1text);\n        const bed2Map = parseBed(bed2text);\n        const feats = mcscantext\n            .split(/\\n|\\r\\n|\\r/)\n            .filter(f => !!f && f !== '###')\n            .map((line, index) => {\n            const [name1, name2, score] = line.split('\\t');\n            const r1 = bed1Map.get(name1);\n            const r2 = bed2Map.get(name2);\n            if (!r1 || !r2) {\n                throw new Error(`feature not found, ${name1} ${name2} ${r1} ${r2}`);\n            }\n            return [r1, r2, +score, index];\n        });\n        return {\n            assemblyNames,\n            feats,\n        };\n    }\n    async hasDataForRefName() {\n        return true;\n    }\n    getAssemblyNames() {\n        const assemblyNames = this.getConf('assemblyNames');\n        return assemblyNames;\n    }\n    async getRefNames(opts = {}) {\n        var _a;\n        const r1 = (_a = opts.regions) === null || _a === void 0 ? void 0 : _a[0].assemblyName;\n        const { feats } = await this.setup(opts);\n        const idx = this.getAssemblyNames().indexOf(r1);\n        if (idx !== -1) {\n            const set = new Set();\n            for (const feat of feats) {\n                set.add(idx === 0 ? feat[0].refName : feat[1].refName);\n            }\n            return [...set];\n        }\n        console.warn('Unable to do ref renaming on adapter');\n        return [];\n    }\n    getFeatures(region, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            const { assemblyNames, feats } = await this.setup(opts);\n            const index = assemblyNames.indexOf(region.assemblyName);\n            if (index !== -1) {\n                const flip = index === 0;\n                for (const f of feats) {\n                    const [r1, r2, score, rowNum] = f;\n                    const [f1, f2] = !flip ? [r2, r1] : [r1, r2];\n                    if (f1.refName === region.refName &&\n                        doesIntersect2(region.start, region.end, f1.start, f1.end)) {\n                        observer.next(new SimpleFeature({\n                            ...f1,\n                            uniqueId: `${index}-${rowNum}`,\n                            syntenyId: rowNum,\n                            strand: f1.strand * f2.strand,\n                            assemblyName: assemblyNames[+!flip],\n                            score,\n                            mate: {\n                                ...f2,\n                                assemblyName: assemblyNames[+flip],\n                            },\n                        }));\n                    }\n                }\n            }\n            observer.complete();\n        });\n    }\n    freeResources() { }\n}\nMCScanAnchorsAdapter.capabilities = ['getFeatures', 'getRefNames'];\nexport default MCScanAnchorsAdapter;\n"],"names":["MCScanAnchorsAdapter","BaseFeatureDataAdapter","opts","e","assemblyNames","pm","bed1","openLocation","bed2","mcscan","bed1text","bed2text","mcscantext","r","readFile","bed1Map","parseBed","bed2Map","feats","f","line","index","name1","name2","score","r1","r2","_a","idx","set","feat","region","ObservableCreate","observer","flip","rowNum","f1","f2","doesIntersect2","SimpleFeature"],"mappings":"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","x_google_ignoreList":[0]}