import{m as Y,c as x,a7 as K,a8 as R,a9 as T,aa as X,j as t,D as Z,T as b,l as ee,e as te,f as ae,B as I}from"./index-CGKDrrCR.js";import{u as ne}from"./index-CmLsXt2o.js";import"./Dialog-DMOWZHAH.js";const{featurizeSA:se,getClip:re,getLength:P,getLengthSansClipping:oe,getTag:M}=K,ie=Y()({root:{width:300}});function me({track:o,feature:m,handleClose:v}){const{classes:E}=ie(),[z,V]=x.useState("0"),[j,C]=x.useState(),[g,k]=x.useState(),u=+z;x.useEffect(()=>{(async()=>{C(void 0);try{if(m.get("flags")&2048){const e=(M(m,"SA")||"").split(";")[0],[c,f]=e.split(","),{rpcManager:y}=R.getSession(o),N=T.getConf(o,"adapter"),p=X.getRpcSessionId(o),s=(await y.call(p,"CoreGetFeatures",{adapterConfig:N,sessionId:p,regions:[{refName:c,start:+f-1,end:+f}]})).find(i=>i.get("name")===m.get("name")&&!(i.get("flags")&2048)&&!(i.get("flags")&256));if(s)k(s);else throw new Error("primary feature not found")}else k(m)}catch(r){console.error(r),C(r)}})()},[m,o]);function _(){var r;try{if(!g)return;const e=g,c=R.getSession(o),f=R.getContainingView(o),y=e.get("CIGAR"),N=e.get("flags"),p=e.get("strand"),L=M(e,"SA")||"",s=e.get("name"),i=re(y,1),h=`${s}_assembly_${Date.now()}`,[l]=T.getConf(o,"assemblyNames"),G=[l,h],q=`track-${Date.now()}`,F=`${s}_vs_${l}`,{assemblyManager:B}=c,$=B.get(l);if(!$)throw new Error("assembly not found");const D=se(L,e.id(),p,s,!0),S=e.toJSON();S.clipPos=i,S.strand=1,S.mate={refName:s,start:i,end:i+oe(y)};const A=N&2048?P(D[0].CIGAR):P(y),d=[S,...D];for(const[a,n]of d.entries())n.refName=$.getCanonicalRefName(n.refName)||n.refName,n.syntenyId=a,n.mate.syntenyId=a,n.mate.uniqueId=`${n.uniqueId}_mate`;d.sort((a,n)=>a.clipPos-n.clipPos);const H=e.get("seq"),O=[...d,...d.map(a=>a.mate)],J=2*u,Q=d.reduce((a,n)=>a+n.end-n.start+J,0),w=`${s}_${Date.now()}`,U=T.getConf($,"sequence"),W=R.gatherOverlaps(d.map(a=>({...a,start:Math.max(0,a.start-u),end:a.end+u,assemblyName:l})));(r=c.addTemporaryAssembly)===null||r===void 0||r.call(c,{name:h,sequence:{type:"ReferenceSequenceTrack",name:"Read sequence",trackId:w,assemblyNames:[h],adapter:{type:"FromConfigSequenceAdapter",noAssemblyManager:!0,features:[{start:0,end:A,seq:H||"",refName:s,uniqueId:`${Math.random()}`}]}}}),c.addView("LinearSyntenyView",{type:"LinearSyntenyView",views:[{type:"LinearGenomeView",hideHeader:!0,offsetPx:0,bpPerPx:Q/f.width,displayedRegions:W,tracks:[{id:`${Math.random()}`,type:"ReferenceSequenceTrack",assemblyNames:[l],configuration:U.trackId,displays:[{id:`${Math.random()}`,type:"LinearReferenceSequenceDisplay",showReverse:!0,showTranslation:!1,height:35,configuration:`${w}-LinearReferenceSequenceDisplay`}]}]},{type:"LinearGenomeView",hideHeader:!0,offsetPx:0,bpPerPx:A/f.width,displayedRegions:[{assemblyName:h,start:0,end:A,refName:s}],tracks:[{id:`${Math.random()}`,type:"ReferenceSequenceTrack",configuration:w,displays:[{id:`${Math.random()}`,type:"LinearReferenceSequenceDisplay",showReverse:!0,showTranslation:!1,height:35,configuration:`${w}-LinearReferenceSequenceDisplay`}]}]}],viewTrackConfigs:[{type:"SyntenyTrack",assemblyNames:G,adapter:{type:"FromConfigAdapter",features:O},trackId:q,name:F}],tracks:[{configuration:q,type:"SyntenyTrack",displays:[{type:"LinearSyntenyDisplay",configuration:`${q}-LinearSyntenyDisplay`}]}],displayName:`${s} vs ${l}`}),v()}catch(e){console.error(e),C(e)}}return t.jsxs(ne.Dialog,{open:!0,onClose:v,title:"Set window size",children:[t.jsx(Z,{children:j?t.jsx(b,{color:"error",children:`${j}`}):g?t.jsxs("div",{className:E.root,children:[g.get("flags")&256?t.jsx(b,{style:{color:"orange"},children:"Note: You selected a secondary alignment (which generally does not have SA tags or SEQ fields) so do a full reconstruction of the alignment"}):null,t.jsx(b,{children:"Show an extra window size around each part of the split alignment. Using a larger value can allow you to see more genomic context."}),t.jsx(te,{value:u,onChange:r=>{V(r.target.value)},label:"Set window size"})]}):t.jsxs("div",{children:[t.jsx(b,{children:"To accurately perform comparison we are fetching the primary alignment. Loading primary feature..."}),t.jsx(ee,{})]})}),t.jsxs(ae,{children:[t.jsx(I,{variant:"contained",color:"secondary",onClick:v,children:"Cancel"}),t.jsx(I,{disabled:!g,variant:"contained",color:"primary",onClick:_,children:"Submit"})]})]})}export{me as default};
//# sourceMappingURL=LinearReadVsRef-Zga6e3oy.js.map
