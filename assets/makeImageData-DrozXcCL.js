import{ba as G,O as F,aD as H,p as I,bc as E,dT as Q,er as $,n as J,bb as K}from"./index-CT2bM4yV.js";import{f as v}from"./color-DtJGFKjr.js";import{g as U}from"./getMaximumModificationAtEachPosition-YoAoUY1_.js";function V(t){return t.get("is_paired")&&t.get("refName")!==t.get("next_ref")?"#555":`hsl(${Math.abs(t.get("template_length"))/10},50%,50%)`}function Y(t){return`hsl(${t.get("score")},50%,50%)`}function Z(t,c){const r=G.readConfObject(c,"orientationType"),P=F[r][t.get("pair_orientation")];return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[P]}function W(t){return t.get("strand")===-1?"#8F8FD8":"#EC8B8B"}function tt(t,c){return v[Z(t,c)||"color_nostrand"]}function et(t){const c=t.get("flags"),r=t.get("strand");if(c&1){const g=c&64?-1:1;return c&2?r*g===1?"color_rev_strand":"color_fwd_strand":c&8?r*g===1?"color_rev_missing_mate":"color_fwd_missing_mate":t.get("refName")===t.get("next_ref")?r*g===1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":r===1?"color_fwd_diff_chr":"color_rev_diff_chr"}return"color_unknown"}function ot(t){return v[et(t)]}function nt({colorType:t,tag:c,feature:r,config:g,defaultColor:P,colorTagMap:i}){switch(t){case"insertSize":return V(r);case"strand":return W(r);case"mappingQuality":return Y(r);case"pairOrientation":return tt(r,g);case"stranded":return ot(r);case"xs":case"tag":{const o=r.get("tags"),h=o?o[c]:r.get(c);return c==="XS"||c==="TS"?h==="-"?v.color_rev_strand:h==="+"?v.color_fwd_strand:v.color_nostrand:c==="ts"?h==="-"?r.get("strand")===-1?v.color_fwd_strand:v.color_rev_strand:h==="+"?r.get("strand")===-1?v.color_rev_strand:v.color_fwd_strand:v.color_nostrand:i[h]||v.color_nostrand}case"insertSizeAndPairOrientation":break;case"modifications":case"methylation":return r.get("flags")&16?"#c8dcc8":"#c8c8c8";default:return P?"lightgrey":G.readConfObject(g,"color",{feature:r})}}function st({ctx:t,feat:c,renderArgs:r}){const{regions:g,bpPerPx:P}=r,{heightPx:i,topPx:o,feature:h}=c,u=g[0],_=h.get("start"),T=h.get("end"),m=h.get("CIGAR"),w=u.reversed?-1:1,C=h.get("strand")*w,b=P<10&&i>5;if(m!=null&&m.includes("N")){const f=H(m);if(C===1){let e=0,n=_;for(let s=0;s<f.length;s+=2){const d=+f[s],l=f[s+1];if(l==="M"||l==="X"||l==="="||l==="D")e+=d;else if(l==="N"){if(n!==e){const[p,S]=I.bpSpanPx(n,n+e,u,P),B=S-p;t.fillRect(p,o,B,i)}n+=e+d,e=0}}if(n!==e){const[s,d]=I.bpSpanPx(n,n+e,u,P),l=d-s;b?(t.beginPath(),t.moveTo(s,o),t.lineTo(s,o+i),t.lineTo(d,o+i),t.lineTo(d+5,o+i/2),t.lineTo(d,o),t.closePath(),t.fill()):t.fillRect(s,o,l,i)}}else if(C===-1){let e=0,n=T;for(let s=f.length-2;s>=0;s-=2){const d=+f[s],l=f[s+1];if(l==="M"||l==="X"||l==="="||l==="D")e+=d;else if(l==="N"){if(e!==0){const[p,S]=I.bpSpanPx(n-e,n,u,P);t.fillRect(p,o,S-p,i)}n-=e+d,e=0}}if(e!==0){const[s,d]=I.bpSpanPx(n-e,n,u,P),l=d-s;b?(t.beginPath(),t.moveTo(s-5,o+i/2),t.lineTo(s,o+i),t.lineTo(d,o+i),t.lineTo(d,o),t.lineTo(s,o),t.closePath(),t.fill()):t.fillRect(s,o,l,i)}}}else{const[f,e]=I.bpSpanPx(_,T,u,P);P<10&&i>5?C===-1?(t.beginPath(),t.moveTo(f-5,o+i/2),t.lineTo(f,o+i),t.lineTo(e,o+i),t.lineTo(e,o),t.lineTo(f,o),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(f,o),t.lineTo(f,o+i),t.lineTo(e,o+i),t.lineTo(e+5,o+i/2),t.lineTo(e,o),t.closePath(),t.fill()):t.fillRect(f,o,e-f,i)}}function R(t,c,r,g,P,i,o){c+g<0||c>i||(o&&(t.fillStyle=o),t.fillRect(c,r,g,P))}function X(t){const{skip:c,deletion:r,insertion:g,hardclip:P,softclip:i,bases:o}=t.palette;return{A:o.A.main,C:o.C.main,G:o.G.main,T:o.T.main,deletion:r,insertion:g,hardclip:P,softclip:i,skip:c}}function it(t){return Object.fromEntries(Object.entries(X(t)).map(([c,r])=>[c,t.palette.getContrastText(r)]))}function rt(t){return["methylation","modifications"].includes(t||"")}function lt(){return!0}function z(){const t=I.measureText("A"),c=I.measureText("M")-2;return{charWidth:t,charHeight:c}}function ct({ctx:t,feat:c,region:r,bpPerPx:g,renderArgs:P,canvasWidth:i,cigarOps:o}){var h,u;const{feature:_,topPx:T,heightPx:m}=c,{colorBy:w,visibleModifications:C={}}=P;if(!_.get("seq"))return;const f=_.get("start"),e=(h=w==null?void 0:w.modifications)===null||h===void 0?void 0:h.isolatedModification,n=(u=w==null?void 0:w.modifications)===null||u===void 0?void 0:u.twoColor,s=U(_,o);if(s){let d=0;for(const{allProbs:l,prob:p,type:S}of s){const B=f+d,[M,a]=I.bpSpanPx(B,B+1,r,g),O=C[S];if(!O){console.warn(`${S} not known yet`);return}if(e&&O.type!==e)return;const A=O.color||"black",j=1-I.sum(l);if(n&&j>I.max(l)){const y=E("blue",j),x=a-M+.5;R(t,M,T,x,m,i,y)}else{const y=E(A,p),x=a-M+.5;R(t,M,T,x,m,i,y)}d++}}}function at({ctx:t,feat:c,region:r,bpPerPx:g,colorMap:P,colorContrastMap:i,charWidth:o,charHeight:h,canvasWidth:u,cigarOps:_}){const T=h-2,{feature:m,topPx:w,heightPx:C}=c,b=m.get("seq"),f=1/g,e=m.get("start");let n=0,s=0;if(b)for(let d=0;d<_.length;d+=2){const l=+_[d],p=_[d+1];if(p==="S"||p==="I")n+=l;else if(p==="D"||p==="N")s+=l;else if(p==="M"||p==="X"||p==="="){for(let S=0;S<l;S++){const B=b[n+S],M=e+s+S,[a]=I.bpSpanPx(M,M+1,r,g),O=P[B];R(t,a,w,f+.5,C,u,O),f>=o&&C>=T&&(t.fillStyle=i[B],t.fillText(B,a+(f-o)/2+1,w+C))}n+=l,s+=l}}}function ft({ctx:t,feat:c,region:r,bpPerPx:g,canvasWidth:P,cigarOps:i}){const{feature:o,topPx:h,heightPx:u}=c,T=(o.get("qual")||"").split(" ").map(f=>+f),m=1/g,w=o.get("start");let C=0,b=0;for(let f=0;f<i.length;f+=2){const e=+i[f],n=i[f+1];if(n==="S"||n==="I")C+=e;else if(n==="D"||n==="N")b+=e;else if(n==="M"||n==="X"||n==="="){for(let s=0;s<e;s++){const d=T[C+s],l=w+b+s,p=I.bpSpanPx(l,l+1,r,g)[0],S=`hsl(${d===255?150:d*1.5},55%,50%)`;R(t,p,h,m+.5,u,P,S)}C+=e,b+=e}}}function pt({ctx:t,feat:c,region:r,bpPerPx:g,renderArgs:P,canvasWidth:i,cigarOps:o}){const{regionSequence:h}=P,{feature:u,topPx:_,heightPx:T}=c;if(!h)throw new Error("region sequence required for methylation");if(!u.get("seq"))return;const w=u.get("start"),C=u.get("end"),{methBins:b,methProbs:f,hydroxyMethBins:e,hydroxyMethProbs:n}=Q(u,o);function s(l){if(b[l]){const p=f[l]||0;return(p>.5?$.colord("red").alpha((p-.5)*2):$.colord("blue").alpha(1-p*2)).toHslString()}if(e[l]){const p=n[l]||0;return(p>.5?$.colord("pink").alpha((p-.5)*2):$.colord("purple").alpha(1-p*2)).toHslString()}}const d=h.toLowerCase();for(let l=0;l<C-w;l++){const p=l+w,S=d[p-r.start+1],B=d[p-r.start+2];if(S==="c"&&B==="g")if(g>2){const[M,a]=I.bpSpanPx(p,p+2,r,g),O=a-M+.5,A=s(l)||s(l+1)||"blue";R(t,M,_,O,T,i,A)}else{const[M,a]=I.bpSpanPx(p,p+1,r,g),O=a-M+.5,A=s(l)||"blue";R(t,M,_,O,T,i,A);const[j,y]=I.bpSpanPx(p+1,p+2,r,g),x=y-j+.5,k=s(l+1)||"blue";R(t,j,_,x,T,i,k)}}}function gt({ctx:t,feat:c,renderArgs:r,colorMap:g,colorContrastMap:P,charWidth:i,charHeight:o,defaultColor:h,canvasWidth:u}){const{config:_,bpPerPx:T,regions:m,colorBy:w,colorTagMap:C={}}=r,{tag:b="",type:f=""}=w||{},{feature:e}=c,n=m[0];switch(t.fillStyle=nt({feature:e,config:_,tag:b,defaultColor:h,colorType:f,colorTagMap:C}),st({ctx:t,feat:c,renderArgs:r}),f){case"perBaseQuality":{const s=H(e.get("CIGAR"));ft({ctx:t,feat:c,region:n,bpPerPx:T,canvasWidth:u,cigarOps:s});break}case"perBaseLettering":{const s=H(e.get("CIGAR"));at({ctx:t,feat:c,region:n,bpPerPx:T,colorMap:g,colorContrastMap:P,charWidth:i,charHeight:o,canvasWidth:u,cigarOps:s});break}case"modifications":{const s=H(e.get("CIGAR"));ct({ctx:t,feat:c,region:n,bpPerPx:T,renderArgs:r,canvasWidth:u,cigarOps:s});break}case"methylation":{const s=H(e.get("CIGAR"));pt({ctx:t,feat:c,region:n,bpPerPx:T,renderArgs:r,canvasWidth:u,cigarOps:s});break}}}function dt({ctx:t,feat:c,renderArgs:r,minSubfeatureWidth:g,largeInsertionIndicatorScale:P,mismatchAlpha:i,charWidth:o,charHeight:h,colorMap:u,colorContrastMap:_,hideSmallIndels:T,canvasWidth:m,drawSNPsMuted:w,drawIndels:C=!0}){const{bpPerPx:b,regions:f}=r,{heightPx:e,topPx:n,feature:s}=c,d=f[0],l=s.get("start"),p=Math.min(1/b,2),S=s.get("mismatches"),B=h-2,M=d.reversed?1/b+1:-1;if(S){for(const a of S){const O=l+a.start,A=a.length,j=a.base,[y,x]=I.bpSpanPx(O,O+A,d,b),k=Math.max(g,x-y);if(a.type==="mismatch"){if(!w){const q=u[a.base]||"#888",D=i&&a.qual!==void 0?$.colord(q).alpha(Math.min(1,a.qual/50)).toHslString():q;R(t,Math.round(y),n,k,e,m,D)}if(k>=o&&e>=B){const q=w?"black":_[a.base]||"black";t.fillStyle=i&&a.qual!==void 0?$.colord(q).alpha(Math.min(1,a.qual/50)).toHslString():q,t.fillText(j,y+(k-o)/2+1,n+e)}}else if(a.type==="deletion"&&C){const q=a.length;if(!T||q>=10){R(t,y,n,Math.abs(y-x),e,m,u.deletion);const D=`${a.length}`,L=I.measureText(D,10);k>=L&&e>=B&&(t.fillStyle=_.deletion,t.fillText(D,(y+x)/2-L/2,n+e))}}else if(a.type==="insertion"&&C){const q=y+M,D=+a.base||a.length,L=Math.max(0,Math.min(1.2,1/b));if(D<10&&!T&&(R(t,q,n,L,e,m,u.insertion),1/b>=o&&e>=B)){const N=Math.round(q-L);R(t,N,n,L*3,1,m),R(t,N,n+e-1,L*3,1,m),t.fillText(`(${a.base})`,q+3,n+e)}}else if(a.type==="hardclip"||a.type==="softclip"){const q=y+M,D=u[a.type],L=Math.max(g,p);if(R(t,q,n,L,e,m,D),1/b>=o&&e>=B){const N=q-L;R(t,N,n,L*3,1,m),R(t,N,n+e-1,L*3,1,m),t.fillText(`(${a.base})`,q+3,n+e)}}else if(a.type==="skip"&&y+k>0){const q=k-(b>10?1.5:0),D=Math.max(0,y),L=n+e/2-1,N=q+Math.min(y,0);R(t,D,L,N,1,m,u.skip)}}if(C)for(const a of S){const O=l+a.start,A=a.length,j=+a.base||a.length;if(a.type==="insertion"&&j>=10){const[y]=I.bpSpanPx(O,O+A,d,b),x=`${j}`;if(b>P)R(t,y-1,n,2,e,m,u.insertion);else if(e>h){const k=I.measureText(x),q=5;R(t,y-k/2-q,n,k+2*q,e,m,"purple"),t.fillStyle=_.insertion,t.fillText(x,y-k/2,n+e)}else R(t,y-2,n,2*2,e,m,u.insertion)}}}}function ut({ctx:t,feat:c,renderArgs:r,config:g,theme:P,colorMap:i,canvasWidth:o}){const{feature:h,topPx:u,heightPx:_}=c,{regions:T,bpPerPx:m}=r,w=T[0],C=G.readConfObject(g,"minSubfeatureWidth"),b=h.get("mismatches"),f=h.get("seq"),{charWidth:e,charHeight:n}=z();if(!(f&&b))return;const s=n-2;let d=0,l=0;const p=h.get("CIGAR"),S=H(p);for(let B=0;B<S.length;B+=2){const M=S[B+1],a=+S[B];if(M==="S"){for(let O=0;O<a;O++){const A=f[d+O],j=h.get("start")-(B===0?a:0)+l+O,[y,x]=I.bpSpanPx(j,j+1,w,m),k=Math.max(C,x-y),q=i[A]||"#000000";t.fillStyle=q,R(t,y,u,k,_,o),k>=e&&_>=s&&(t.fillStyle=P.palette.getContrastText(q),t.fillText(A,y+(k-e)/2+1,u+_))}d+=a}M==="N"&&(l+=a),(M==="M"||M==="="||M==="X")&&(l+=a,d+=a),M==="D"&&(l+=a),M==="I"&&(d+=a)}}function _t({ctx:t,layoutRecords:c,canvasWidth:r,renderArgs:g}){const{stopToken:P,config:i,showSoftClip:o,colorBy:h,theme:u}=g,_=G.readConfObject(i,"mismatchAlpha"),T=G.readConfObject(i,"minSubfeatureWidth"),m=G.readConfObject(i,"largeInsertionIndicatorScale"),w=G.readConfObject(i,"hideSmallIndels"),C=G.readConfObject(i,"color")==="#f0f",b=J.createJBrowseTheme(u),f=X(b),e=it(b);t.font="bold 10px Courier New,monospace";const{charWidth:n,charHeight:s}=z(),d=rt(h==null?void 0:h.type),l=lt();let p=performance.now();for(const S of c)performance.now()-p>400&&(K(P),p=performance.now()),gt({ctx:t,feat:S,renderArgs:g,defaultColor:C,colorMap:f,colorContrastMap:e,charWidth:n,charHeight:s,canvasWidth:r}),dt({ctx:t,feat:S,renderArgs:g,hideSmallIndels:w,mismatchAlpha:_,drawSNPsMuted:d,drawIndels:l,largeInsertionIndicatorScale:m,minSubfeatureWidth:T,charWidth:n,charHeight:s,colorMap:f,colorContrastMap:e,canvasWidth:r}),o&&ut({ctx:t,feat:S,renderArgs:g,colorMap:f,config:i,theme:b,canvasWidth:r})}export{_t as makeImageData};
//# sourceMappingURL=makeImageData-DrozXcCL.js.map
