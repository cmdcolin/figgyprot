import{U as R,V as W,a8 as h,d3 as _,k as F,aD as V}from"./index-CGKDrrCR.js";import{d as A,c as D}from"./drawSynteny-BYnW9s8U.js";var P={};Object.defineProperty(P,"__esModule",{value:!0});P.moveTo=I;P.pxToBp=O;var b=P.bpToPx=U;P.bpToPxMap=j;function E(t,e,n){let r=0;const{displayedRegions:l}=t;if(e.index===n.index)r+=n.offset-e.offset;else{const d=l[e.index];if(r+=d.end-d.start-e.offset,n.index-e.index>=2)for(let c=e.index+1;c<n.index;c++){const u=l[c],i=u.end-u.start;r+=i}r+=n.offset}return r}function I(t,e,n){if(!e||!n)return;const{width:r,interRegionPaddingWidth:l,displayedRegions:d,bpPerPx:c,minimumBlockWidth:u}=t,i=E(t,e,n);let p=0;for(let s=e.index;s<n.index;s++){const a=d[s];(a.end-a.start)/c>u&&p++}const f=i/(r-l*p),m=t.zoomTo(f);let v=0;f<m&&(v=(m-f)*t.width/2);let o=-v;for(let s=0;s<t.displayedRegions.length;s++){const a=t.displayedRegions[s];if(e.index===s){o+=e.offset;break}else o+=a.end-a.start}t.scrollTo(Math.round(o/t.bpPerPx))}function B(t,e){return Math.floor(t.reversed?t.end-e:t.start+e)+1}function O(t,e){var n;let r=0;const{bpPerPx:l,offsetPx:d,displayedRegions:c,interRegionPaddingWidth:u,staticBlocks:i}=t,p=i.contentBlocks,f=(d+e)*l;if(f<0){const o=c[0];return{...o,oob:!0,coord:B(o,f),offset:f,index:0}}const m=u*l;let v=0;for(let o=0;o<c.length;o++){const s=c[o],a=s.end-s.start,g=f-r;if(a+r>f&&r<=f)return{...s,oob:!1,offset:g,coord:B(s,g),index:o};((n=p[v])===null||n===void 0?void 0:n.regionNumber)===o?(r+=a+m,v++):r+=a}if(f>=r&&c.length>0){const o=c.at(-1),s=o.end-o.start,a=f-r+s;return{...o,oob:!0,offset:a,coord:B(o,a),index:c.length-1}}return{coord:0,index:0,refName:"",oob:!0,assemblyName:"",offset:0,start:0,end:0,reversed:!1}}function U({refName:t,coord:e,regionNumber:n,self:r}){var l;let d=0;const{interRegionPaddingWidth:c,bpPerPx:u,displayedRegions:i,staticBlocks:p}=r,f=p.contentBlocks,m=c*u;let v=0,o=0;for(;o<i.length;o++){const a=i[o],g=a.end-a.start;if(t===a.refName&&e>=a.start&&e<=a.end&&(!n||n===o)){d+=a.reversed?a.end-e:e-a.start;break}((l=f[v])===null||l===void 0?void 0:l.regionNumber)===o?(d+=g+m,v++):d+=g}if(i[o])return{index:o,offsetPx:Math.round(d/u)}}function j({refName:t,coord:e,regionNumber:n,self:r}){var l;let d=0;const{interRegionPaddingWidth:c,bpPerPx:u,displayedRegions:i,staticBlocks:p}=r,f=p.contentBlocks,m=c*u,v={};let o=0,s=0;for(;s<i.length;s++){const g=i[s],x=g.end-g.start;if(t===g.refName&&e>=g.start&&e<=g.end&&(n===void 0||n===s)){d+=g.reversed?g.end-e:e-g.start;break}((l=f[o])===null||l===void 0?void 0:l.regionNumber)===s?(d+=x+m,o++):d+=x}return i[s]?{index:s,offsetPx:Math.round(d/u)}:v}function q(t){R(t,W(()=>{var e,n;const r=h.getContainingView(t);if(!r.initialized||!r.views.every(i=>i.displayedRegions.length>0&&i.initialized))return;const l=(e=t.mainCanvas)===null||e===void 0?void 0:e.getContext("2d"),d=(n=t.cigarClickMapCanvas)===null||n===void 0?void 0:n.getContext("2d");if(!l||!d)return;const c=t.height,u=r.width;l.clearRect(0,0,u,c),d.clearRect(0,0,u,c),A(t,l,d)})),R(t,W(()=>{const e=h.getContainingView(t);!e.initialized||!e.views.every(n=>n.displayedRegions.length>0&&n.initialized)||D(t)})),R(t,_(()=>{const e=h.getContainingView(t);return{bpPerPx:e.views.map(n=>n.bpPerPx),displayedRegions:JSON.stringify(e.views.map(n=>n.displayedRegions)),features:t.features,initialized:e.initialized&&e.views.every(n=>n.displayedRegions.length>0&&n.initialized)}},({initialized:e})=>{if(!e)return;const{level:n}=t,{assemblyManager:r}=h.getSession(t),d=h.getContainingView(t).views.map(i=>({...F(i),width:i.width,staticBlocks:i.staticBlocks,interRegionPaddingWidth:i.interRegionPaddingWidth,minimumBlockWidth:i.minimumBlockWidth})),c=[],u=t.features||[];for(const i of u){const p=i.get("mate");let f=i.get("start"),m=i.get("end");const v=p.start,o=p.end;i.get("strand")===-1&&([m,f]=[f,m]);const s=r.get(i.get("assemblyName")),a=r.get(p.assemblyName),g=i.get("refName"),x=p.refName,y=(s==null?void 0:s.getCanonicalRefName(g))||g,k=(a==null?void 0:a.getCanonicalRefName(x))||x,w=d[n],N=d[n+1],C=b({self:w,refName:y,coord:f}),T=b({self:w,refName:y,coord:m}),M=b({self:N,refName:k,coord:v}),S=b({self:N,refName:k,coord:o});if(C===void 0||T===void 0||M===void 0||S===void 0)continue;const z=i.get("CIGAR");c.push({p11:C,p12:T,p21:M,p22:S,f:i,cigar:V(z)})}t.setFeatPositions(c)},{fireImmediately:!0}))}export{q as doAfterAttach};
//# sourceMappingURL=afterAttach-ZsY2L49h.js.map
