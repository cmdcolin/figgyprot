import{fp as B,bN as b,fq as J,fj as X,fr as N,am as x,an as q,cf as P,az as Y,fl as L,fm as Z,fs as ee,ft as te,a3 as z}from"./index-CGKDrrCR.js";var re={},_={};Object.defineProperty(_,"__esModule",{value:!0});_.isSequenceAdapter=ne;_.isRegionsAdapter=ae;_.isFeatureAdapter=se;_.isRefNameAliasAdapter=ie;_.isTextSearchAdapter=oe;function ne(a){return"getRegions"in a&&"getFeatures"in a}function ae(a){return"getRegions"in a}function se(a){return"getFeatures"in a}function ie(a){return"getRefNameAliases"in a}function oe(a){return"searchIndex"in a}var U={};Object.defineProperty(U,"__esModule",{value:!0});var C={},I={};Object.defineProperty(I,"__esModule",{value:!0});I.default=ce;const k=B();function ce(a,e="",t=5e3){const r=[a];for(;r.length;){const n=r.pop();for(const[i,s]of Object.entries(n)){if(e.length>t)return(0,k.hashCode)(e);typeof s=="object"&&s!==null?r.push(s):e+=`${i}-${s}`}}return`adp-${(0,k.hashCode)(e)}`}var ue=b&&b.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(C,"__esModule",{value:!0});C.BaseAdapter=void 0;const O=X,W=J(),fe=ue(I),he=(0,W.ConfigurationSchema)("empty",{});class Q{constructor(e=he.create(),t,r){if(this.config=e,this.getSubAdapter=t,this.pluginManager=r,typeof jest>"u"){const n=(0,O.isStateTreeNode)(e)?(0,O.getSnapshot)(e):e;this.id=`${(0,fe.default)(n)}`}else this.id="test"}getConf(e){return(0,W.readConfObject)(this.config,e)}}C.BaseAdapter=Q;Q.capabilities=[];var D={},E={};Object.defineProperty(E,"__esModule",{value:!0});var Le=E.ObservableCreate=ge;const le=x,de=N;function ge(a,e){return(0,de.checkStopToken)(e),new le.Observable(t=>{try{const r=a(t);r!=null&&r.catch&&r.catch(n=>{t.error(n)})}catch(r){t.error(r)}})}var A={};Object.defineProperty(A,"__esModule",{value:!0});A.calcStdFromSums=H;A.rectifyStats=V;A.scoresToStats=be;A.blankStats=K;const me=x,pe=q;function H(a,e,t,r=!1){if(t===0)return 0;let n;return r?n=e/t-a*a/(t*t):(n=e-a*a/t,t>1&&(n/=t-1)),n<0?0:Math.sqrt(n)}function V(a){return{...a,scoreMean:(a.scoreSum||0)/(a.featureCount||a.basesCovered||1),scoreStdDev:H(a.scoreSum,a.scoreSumSquares,a.featureCount||a.basesCovered),featureDensity:(a.featureCount||1)/a.basesCovered}}async function be(a,e){const{start:t,end:r}=a,n={scoreMin:Number.MAX_VALUE,scoreMax:Number.MIN_VALUE,scoreSum:0,scoreSumSquares:0,featureCount:0};let i=!1;const{scoreMin:s,scoreMax:o,scoreSum:c,scoreSumSquares:f,featureCount:u}=await(0,me.firstValueFrom)(e.pipe((0,pe.reduce)((l,g)=>{const m=g.get("score"),v=g.get("summary"),{scoreMax:R,scoreMin:h}=l;return l.scoreMax=Math.max(R,v?g.get("maxScore"):m),l.scoreMin=Math.min(h,v?g.get("minScore"):m),l.scoreSum+=m,l.scoreSumSquares+=m*m,l.featureCount+=1,i=!0,l},n)));return i?V({scoreMax:o,scoreMin:s,scoreSum:c,scoreSumSquares:f,featureCount:u,basesCovered:r-t+1}):K()}function K(){return{scoreMin:0,scoreMax:0,scoreMean:0,scoreStdDev:0,scoreSum:0,scoreSumSquares:0,featureCount:0,featureDensity:0,basesCovered:0}}Object.defineProperty(D,"__esModule",{value:!0});D.BaseFeatureDataAdapter=void 0;const M=x,j=q,_e=C,y=B(),Se=E,T=A,ye=N;class we extends _e.BaseAdapter{async getHeader(e){return null}async getMetadata(e){return null}getFeaturesInRegion(e,t={}){return(0,Se.ObservableCreate)(async r=>{const n=await this.hasDataForRefName(e.refName,t);(0,ye.checkStopToken)(t.stopToken),n?this.getFeatures(e,t).subscribe(r):r.complete()})}getFeaturesInMultipleRegions(e,t={}){return(0,M.merge)(...e.map(r=>this.getFeaturesInRegion(r,t)))}async hasDataForRefName(e,t={}){return(await this.getRefNames(t)).includes(e)}async getRegionQuantitativeStats(e,t){const r=this.getFeatures(e,t);return(0,T.scoresToStats)(e,r)}async getMultiRegionQuantitativeStats(e=[],t){if(!e.length)return(0,T.blankStats)();const r=await Promise.all(e.map(u=>this.getRegionQuantitativeStats(u,t))),n=(0,y.max)(r.map(u=>u.scoreMax)),i=(0,y.min)(r.map(u=>u.scoreMin)),s=(0,y.sum)(r.map(u=>u.scoreSum)),o=(0,y.sum)(r.map(u=>u.scoreSumSquares)),c=(0,y.sum)(r.map(u=>u.featureCount)),f=(0,y.sum)(r.map(u=>u.basesCovered));return(0,T.rectifyStats)({scoreMin:i,scoreMax:n,featureCount:c,basesCovered:f,scoreSumSquares:o,scoreSum:s})}getRegionFeatureDensityStats(e,t){let r=+Date.now();const n=async(s,o)=>{const{start:c,end:f}=e,u=c*.75+f*.25,l=await(0,M.firstValueFrom)(this.getFeatures({...e,start:Math.max(0,Math.round(u-s/2)),end:Math.min(Math.round(u+s/2),f)},t).pipe((0,j.toArray)()));return i({interval:s,statsSampleFeatures:l.length,expansionTime:o,stats:{featureDensity:l.length/s}})},i=async({interval:s,stats:o,statsSampleFeatures:c,expansionTime:f})=>{const u=e.end-e.start;if(c>=70||s*2>u)return o;if(f<=5e3){const l=+Date.now();return f+=l-r,r=l,n(s*2,f)}else return console.warn("Stats estimation reached timeout, or didn't get enough features"),{featureDensity:Number.POSITIVE_INFINITY}};return n(1e3,0)}async getMultiRegionFeatureDensityStats(e,t){if(!e.length)throw new Error("No regions supplied");return this.getRegionFeatureDensityStats(e[0],t)}async getSources(e){const t=await(0,M.firstValueFrom)(this.getFeaturesInMultipleRegions(e).pipe((0,j.toArray)())),r=new Set;for(const n of t)r.add(n.get("source"));return[...r].map(n=>({name:n}))}}D.BaseFeatureDataAdapter=we;var F={};Object.defineProperty(F,"__esModule",{value:!0});F.BaseSequenceAdapter=void 0;const Ae=D;class ve extends Ae.BaseFeatureDataAdapter{async getMultiRegionFeatureDensityStats(){return{featureDensity:0}}}F.BaseSequenceAdapter=ve;(function(a){var e=b&&b.__createBinding||(Object.create?function(s,o,c,f){f===void 0&&(f=c);var u=Object.getOwnPropertyDescriptor(o,c);(!u||("get"in u?!o.__esModule:u.writable||u.configurable))&&(u={enumerable:!0,get:function(){return o[c]}}),Object.defineProperty(s,f,u)}:function(s,o,c,f){f===void 0&&(f=c),s[f]=o[c]}),t=b&&b.__exportStar||function(s,o){for(var c in s)c!=="default"&&!Object.prototype.hasOwnProperty.call(o,c)&&e(o,s,c)};Object.defineProperty(a,"__esModule",{value:!0}),a.BaseSequenceAdapter=a.BaseFeatureDataAdapter=a.BaseAdapter=void 0,t(_,a),t(U,a);var r=C;Object.defineProperty(a,"BaseAdapter",{enumerable:!0,get:function(){return r.BaseAdapter}});var n=D;Object.defineProperty(a,"BaseFeatureDataAdapter",{enumerable:!0,get:function(){return n.BaseFeatureDataAdapter}});var i=F;Object.defineProperty(a,"BaseSequenceAdapter",{enumerable:!0,get:function(){return i.BaseSequenceAdapter}})})(re);var Ce={},w={};function De(a){if(typeof a!="string")return{};const e={};return a.toLowerCase().replace(/(?:^|(?:\s*,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,n,i,s)=>{const o=i||s;return e[n]=o?o.toLowerCase():!0,""})?{}:(Object.keys(e).forEach(r=>{if(/^[\d]+$/.test(`${e[r]}`))try{const n=parseInt(`${e[r]}`,10);Number.isNaN(n)||(e[r]=n)}catch{}}),e)}class Fe{constructor({minimumTTL:e}){this.minimumTTL=e}calculateChunkExpirationDate(e){const{headers:t={},requestDate:r,responseDate:n}=e,{date:i,pragma:s}=t;let o=n||r;if(!o){if(!i)return;o=new Date(i)}const c=u=>new Date(o.getTime()+u);if(/\bno-cache\b/.test(s||""))return c(this.minimumTTL);const f=De(t["cache-control"]||"");if(f["no-cache"]||f["no-store"]||f["must-revalidate"])return c(this.minimumTTL);if(f["max-age"]!==void 0){const u=+f["max-age"]*1e3;return c(Math.max(u,this.minimumTTL))}else{if(this._coerceToDate(t.expires))return this._coerceToDate(t.expires);if(this._coerceToDate(t["last-modified"])){const u=this._coerceToDate(t["last-modified"]),l=(o.getTime()-((u==null?void 0:u.getTime())||0))/10;return c(l)}}}_coerceToDate(e){if(e){if(e instanceof Date)return e;if(typeof e=="string"||typeof e=="number")return new Date(e)}}cachedChunkIsValid(e){const t=this.calculateChunkExpirationDate(e);return!t||new Date<=t}chunkIsCacheable(e){return!0}}class Re{constructor({fetch:e,frequency:t=100,maxExtraSize:r=32e3,maxFetchSize:n=1e6}){this.requestQueues={},this.fetchCallback=e,this.frequency=t,this.maxExtraSize=r,this.maxFetchSize=n}_canAggregate(e,t){return t.start<=e.end+this.maxExtraSize&&t.end-t.start+e.end-e.start<this.maxFetchSize}_allSignalsFired(e){return new Promise(t=>{let r=e.filter(n=>!n.aborted).length;e.forEach(n=>{n.addEventListener("abort",()=>{r-=1,r||t()})})}).catch(t=>{console.error(t)})}_dispatch({url:e,start:t,end:r,requests:n}){const i=new AbortController,s=[];n.forEach(({requestOptions:o})=>{o.signal&&s.push(o.signal)}),s.length===n.length&&this._allSignalsFired(s).then(()=>{i.abort()}),this.fetchCallback(e,t,r-1,{signal:i.signal}).then(o=>{const c=o.buffer;n.forEach(({start:f,end:u,resolve:l})=>{l({headers:o.headers,buffer:c.subarray(f-t,u-t)})})}).catch(o=>{n.forEach(({reject:c})=>{c(o)})})}_aggregateAndDispatch(){Object.entries(this.requestQueues).forEach(([e,t])=>{if(!t.length)return;const r=[];if(t.forEach(i=>{var c;const{requestOptions:s,reject:o}=i;(c=s.signal)!=null&&c.aborted?o(Object.assign(new Error("aborted"),{code:"ERR_ABORTED"})):r.push(i)}),r.sort((i,s)=>i.start-s.start),t.length=0,!r.length)return;let n;for(const i of r)n&&this._canAggregate(n,i)?(n.requests.push(i),n.end=i.end):(n&&this._dispatch(n),n={requests:[i],url:e,start:i.start,end:i.end});n&&this._dispatch(n)})}_enQueue(e,t){this.requestQueues[e]||(this.requestQueues[e]=[]),this.requestQueues[e].push(t)}fetch(e,t,r,n={}){return new Promise((i,s)=>{this._enQueue(e,{start:t,end:r,resolve:i,reject:s,requestOptions:n}),this.timeout||(this.timeout=setTimeout(()=>{this.timeout=void 0,this._aggregateAndDispatch()},this.frequency||1))})}}async function Me(a,e,t,r={}){const n=new Date,i=Object.assign({method:"GET",headers:{range:`bytes=${e}-${t}`}},r),s=await fetch(a,i),o=new Date;if(s.status!==206&&s.status!==200)throw new Error(`HTTP ${s.status} when fetching ${a} bytes ${e}-${t}`);if(s.status===200)throw new Error(`HTTP ${s.status} when fetching ${a} bytes ${e}-${t}`);const c=new Uint8Array(await s.arrayBuffer());return{headers:s.headers.map,requestDate:n,responseDate:o,buffer:c}}function Te(a){let e=0;for(const t of a)e+=t.length;return e}function $e(a){const e=new Uint8Array(Te(a));let t=0;for(const r of a)e.set(r,t),t+=r.length;return e}function Be(a){return a.name==="AbortError"||a.code==="ERR_ABORTED"||!!a.message.match(/\b(aborted|AbortError)\b/i)}class xe{constructor({fetch:e=Me,size:t=1e7,chunkSize:r=32768,aggregationTime:n=100,minimumTTL:i=1e3,maxFetchSize:s=r*4,maxExtraFetch:o=r}){this.aggregator=new Re({fetch:e,frequency:n,maxFetchSize:s,maxExtraSize:o}),this.chunkSize=r,this.chunkCache=new P({maxSize:Math.floor(t/r)||1}),this.cacheSemantics=new Fe({minimumTTL:i}),this.stats=new P({maxSize:20})}async getRange(e,t,r,n={}){const i=Math.floor(t/this.chunkSize),s=Math.floor((t+r-1)/this.chunkSize),o=new Array(s-i+1);for(let u=i;u<=s;u+=1)o[u-i]=this._getChunk(e,u,n).then(l=>l&&{headers:l.headers,buffer:l.buffer,chunkNumber:u});let c=await Promise.all(o);if(c=c.filter(u=>!!u),!c.length)return{headers:{},buffer:new Uint8Array(0)};const f=t-c[0].chunkNumber*this.chunkSize;return{headers:this._makeHeaders(c[0].headers,t,t+r-1),buffer:this._makeBuffer(c,f,r)}}_makeBuffer(e,t,r){if(e.length===1)return e[0].buffer.slice(t,t+r);if(e.length===0)return new Uint8Array(0);{const n=e.map(c=>c.buffer),i=n.shift().slice(t);let s=n.pop(),o=i.length+n.reduce((c,f)=>c+f.length,0)+s.length-r;return o<0&&(o=0),s=s.slice(0,s.length-o),$e([i,...n,s])}}async stat(e){let t=this.stats.get(e);if(!t){const r=await this._getChunk(e,0);if(r&&this._recordStatsIfNecessary(e,r),t=this.stats.get(e),!t)throw new Error(`failed to retrieve file size for ${e}`)}return t}_headersToStats(e){const{headers:t}=e,r={};if(t!=null&&t["content-range"]){const n=/\d+-\d+\/(\d+)/.exec(t["content-range"]);if(n){const i=parseInt(n[1],10);Number.isNaN(i)||(r.size=i)}}return t!=null&&t["last-modified"]&&(r.mtime=new Date(t["last-modified"]),r.mtime.toString()==="Invalid Date"&&(console.warn("Invalid Date"),r.mtime=new Date),r.mtimeMs=r.mtime.getTime()),r}_makeHeaders(e,t,r){const n={...e},i=/\d+-\d+\/(\d+)/.exec(n["content-range"]||"");return{...e,"content-length":r-t,"content-range":`${t}-${r-1}/${i==null?void 0:i[1]}`,"x-resource-length":i==null?void 0:i[1]}}async _getChunk(e,t,r){const n=`${e}/${t}`,i=this.chunkCache.get(n);if(i){let l,g=!1;try{l=await i}catch(m){if(Be(m))g=!0;else throw m}return l&&(g||!this.cacheSemantics.cachedChunkIsValid(l))?(this._uncacheIfSame(n,i),this._getChunk(e,t,r)):(l&&this._recordStatsIfNecessary(e,l),l)}const s=t*this.chunkSize;let o=s+this.chunkSize;const c=this.stats.get(e);if(c!=null&&c.size){if(s>=c.size)return;o>=c.size&&(o=c.size)}const f=this.aggregator.fetch(e,s,o,r).catch(l=>{throw this._uncacheIfSame(n,f),l});this.chunkCache.set(n,f);const u=await f;return this._recordStatsIfNecessary(e,u),this.cacheSemantics.chunkIsCacheable(u)||this._uncacheIfSame(n,f),u}_recordStatsIfNecessary(e,t){this.stats.has(e)||this.stats.set(e,this._headersToStats(t))}_uncacheIfSame(e,t){this.chunkCache.get(e)===t&&this.chunkCache.delete(e)}reset(){this.stats.clear(),this.chunkCache.clear()}}const Ie=Object.freeze(Object.defineProperty({__proto__:null,HttpRangeFetcher:xe},Symbol.toStringTag,{value:"Module"})),Ee=Y(Ie);Object.defineProperty(w,"__esModule",{value:!0});w.RemoteFileWithRangeCache=void 0;w.clearCache=je;const Pe=Ee,ke=L,$={};function Oe(a,e,t,r={}){const n=$[a];if(!n)throw new Error(`fetch not registered for ${a}`);return n(a,e,t,r)}const G=new Pe.HttpRangeFetcher({fetch:Oe,size:500*1024**2,chunkSize:128*1024,maxFetchSize:100*1024**2,minimumTTL:24*60*60*1e3});function je(){G.reset()}class Ne extends ke.RemoteFile{async fetch(e,t){const r=String(e);$[r]||($[r]=this.fetchBinaryRange.bind(this));const n=new Headers(t==null?void 0:t.headers).get("range");if(n){const i=/bytes=(\d+)-(\d+)/.exec(n);if(i){const[,s,o]=i,c=Number.parseInt(s,10),u=Number.parseInt(o,10)-c,{buffer:l,headers:g}=await G.getRange(`${e}`,c,u+1);return new Response(l,{status:206,headers:g})}}return super.fetch(e,t)}async fetchBinaryRange(e,t,r,n={}){const i=new Date,s=await super.fetch(e,{...n,headers:{...n.headers,range:`bytes=${t}-${r}`}}),o=new Date;if(!s.ok){const u=`HTTP ${s.status} fetching ${e} bytes ${t}-${r}`,l=" (should be 206 for range requests)";throw new Error(`${u}${s.status===200?l:""}`)}const c={};for(const[u,l]of s.headers.entries())c[u]=l;const f=await s.arrayBuffer();return{headers:c,requestDate:i,responseDate:o,buffer:new Uint8Array(f)}}}w.RemoteFileWithRangeCache=Ne;(function(a){var e=b&&b.__importDefault||function(h){return h&&h.__esModule?h:{default:h}};Object.defineProperty(a,"__esModule",{value:!0}),a.RemoteFileWithRangeCache=void 0,a.resolveUriLocation=u,a.openLocation=l,a.getFetcher=g;const t=e(Z),r=L,n=w,i=B(),s=te,o=ee();function c(h){return"localPath"in h}function f(h){return"blobId"in h}function u(h){return h.baseUri?{...h,uri:new URL(h.uri,h.baseUri).href}:h}function l(h,p){if(c(h)){if(!h.localPath)throw new Error("No local path provided");if(t.default||i.isElectron)return new r.LocalFile(h.localPath);throw new Error("can't use local files in the browser")}if(f(h)){const d=(0,s.getBlob)(h.blobId);if(!d)throw new Error(`file ("${h.name}") was opened locally from a previous session. To restore it, go to track settings and reopen the file`);return new r.BlobFile(d)}if((0,o.isUriLocation)(h)){if(!h.uri)throw new Error("No URI provided");const d=u(h);if(p){const S=m(h,p);if(S)return S.openLocation(d)}return new n.RemoteFileWithRangeCache(d.uri,{fetch:v})}throw new Error("invalid fileLocation")}function g(h,p){if(!(0,o.isUriLocation)(h))throw new Error(`Not a valid UriLocation: ${JSON.stringify(h)}`);if(p){const d=m(h,p);if(d)return d.getFetcher(h)}return v}function m(h,p){const{rootModel:d}=p;if(d&&(0,o.isRootModelWithInternetAccounts)(d))return d.findAppropriateInternetAccount(h);if(h.internetAccountPreAuthorization){if(!h.internetAccountPreAuthorization.authInfo.token)throw new Error("Failed to obtain token from internet account. Try reloading the page");return p.getInternetAccountType(h.internetAccountPreAuthorization.internetAccountType).stateModel.create({type:h.internetAccountPreAuthorization.internetAccountType,configuration:h.internetAccountPreAuthorization.authInfo.configuration})}}async function v(h,p){var d;const S=await fetch(h,p);if(S.status===401&&(!((d=S.headers.get("WWW-Authenticate"))===null||d===void 0)&&d.includes("Basic")))throw new o.AuthNeededError("Accessing HTTPBasic resource without authentication",h.toString());return S}var R=w;Object.defineProperty(a,"RemoteFileWithRangeCache",{enumerable:!0,get:function(){return R.RemoteFileWithRangeCache}})})(Ce);function ze(a){return new Map(a.split(/\n|\r\n|\r/).filter(e=>!!e||e.startsWith("#")).map(e=>{const[t,r,n,i,s,o]=e.split("	");return[i,{refName:t,start:+r,end:+n,score:+s,name:i,strand:o==="-"?-1:1}]}))}async function Ue(a,e){return z.fetchAndMaybeUnzipText(a,e)}function We(a,e){return a.map((t,r)=>[t,e[r]])}function Qe(a,e,t){const{statusCallback:r=()=>{}}=t||{};let n=0;const i=[],s=new TextDecoder("utf8");let o=0;for(;n<a.length;){const c=a.indexOf(10,n);if(c===-1)break;const f=a.subarray(n,c),u=s.decode(f).trim();if(u){const l=e(u);l&&i.push(l)}o++%1e4===0&&r(`Loading ${z.getProgressDisplayStr(n,a.length)}`),n=c+1}return i}function He(a){const e=a.split("	"),t=e.slice(12),r={numMatches:+e[9],blockLen:+e[10],mappingQual:+e[11]};if(t.length)for(const n of t){const i=n.indexOf(":");r[n.slice(0,i)]=n.slice(i+3)}return{tname:e[5],tstart:+e[7],tend:+e[8],qname:e[0],qstart:+e[2],qend:+e[3],strand:e[4]==="-"?-1:1,extra:r}}function Ve(a){const e=[];for(let t=a.length-2;t>=0;t-=2){e.push(a[t]);const r=a[t+1];r==="D"?e.push("I"):r==="I"?e.push("D"):e.push(r)}return e}function Ke(a){return a.replaceAll("D","K").replaceAll("I","D").replaceAll("K","I")}export{re as B,Le as O,ze as a,He as b,Ve as f,Ce as i,Qe as p,Ue as r,Ke as s,We as z};
//# sourceMappingURL=util-B_L2Y7L7.js.map
