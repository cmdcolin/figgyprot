{"version":3,"file":"BlastTabularAdapter-D8T3WaHb.js","sources":["../../node_modules/@jbrowse/plugin-comparative-adapters/esm/BlastTabularAdapter/BlastTabularAdapter.js"],"sourcesContent":["import { readConfObject } from '@jbrowse/core/configuration';\nimport { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { doesIntersect2, fetchAndMaybeUnzip } from '@jbrowse/core/util';\nimport { openLocation } from '@jbrowse/core/util/io';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport SyntenyFeature from '../SyntenyFeature';\nimport { parseLineByLine } from '../util';\nfunction createBlastLineParser(columns) {\n    const columnNames = columns.trim().split(' ');\n    const qseqidIndex = columnNames.indexOf('qseqid');\n    if (qseqidIndex === -1) {\n        throw new Error('Missing required column \"qseqid\"');\n    }\n    const sseqidIndex = columnNames.indexOf('sseqid');\n    if (sseqidIndex === -1) {\n        throw new Error('Missing required column \"sseqid\"');\n    }\n    const qstartIndex = columnNames.indexOf('qstart');\n    if (qstartIndex === -1) {\n        throw new Error('Missing required column \"qstart\"');\n    }\n    const qendIndex = columnNames.indexOf('qend');\n    if (qendIndex === -1) {\n        throw new Error('Missing required column \"qend\"');\n    }\n    const sstartIndex = columnNames.indexOf('sstart');\n    if (sstartIndex === -1) {\n        throw new Error('Missing required column \"sstart\"');\n    }\n    const sendIndex = columnNames.indexOf('send');\n    if (sendIndex === -1) {\n        throw new Error('Missing required column \"send\"');\n    }\n    const columnNameSet = new Map(columnNames\n        .map((c, idx) => [c, idx])\n        .filter(f => !['qseqid', 'sseqid', 'qstart', 'qend', 'sstart', 'send'].includes(f[0])));\n    return (line) => {\n        if (line.startsWith('#')) {\n            return;\n        }\n        const row = line.split('\\t');\n        const qseqid = row[qseqidIndex];\n        const sseqid = row[sseqidIndex];\n        const qstart = row[qstartIndex];\n        const qend = row[qendIndex];\n        const sstart = row[sstartIndex];\n        const send = row[sendIndex];\n        if (!(qseqid && sseqid && qstart && qend && sstart && send)) {\n            console.warn('Invalid BLAST line');\n            console.warn(line);\n            return;\n        }\n        const record = {\n            qseqid,\n            sseqid,\n            qstart: Number.parseInt(qstart),\n            qend: Number.parseInt(qend),\n            sstart: Number.parseInt(sstart),\n            send: Number.parseInt(send),\n        };\n        for (const [columnName, idx] of columnNameSet.entries()) {\n            const value = row[idx];\n            if (!value) {\n                continue;\n            }\n            record[columnName] = value;\n        }\n        return record;\n    };\n}\nclass BlastTabularAdapter extends BaseFeatureDataAdapter {\n    getData(opts) {\n        if (!this.data) {\n            this.data = this.setup(opts).catch((e) => {\n                this.data = undefined;\n                throw e;\n            });\n        }\n        return this.data;\n    }\n    async setup(opts) {\n        const pm = this.pluginManager;\n        const buf = await fetchAndMaybeUnzip(openLocation(readConfObject(this.config, 'blastTableLocation'), pm), opts);\n        const columns = readConfObject(this.config, 'columns');\n        return parseLineByLine(buf, createBlastLineParser(columns), opts);\n    }\n    async hasDataForRefName() {\n        return true;\n    }\n    getAssemblyNames() {\n        const assemblyNames = this.getConf('assemblyNames');\n        if (assemblyNames.length === 0) {\n            const query = this.getConf('queryAssembly');\n            const target = this.getConf('targetAssembly');\n            return [query, target];\n        }\n        return assemblyNames;\n    }\n    async getRefNames(opts = {}) {\n        var _a;\n        const r1 = (_a = opts.regions) === null || _a === void 0 ? void 0 : _a[0].assemblyName;\n        const feats = await this.getData(opts);\n        const idx = this.getAssemblyNames().indexOf(r1);\n        if (idx !== -1) {\n            const set = new Set();\n            for (const feat of feats) {\n                set.add(idx === 0 ? feat.qseqid : feat.sseqid);\n            }\n            return [...set];\n        }\n        console.warn('Unable to do ref renaming on adapter');\n        return [];\n    }\n    getFeatures(query, opts = {}) {\n        return ObservableCreate(async (observer) => {\n            const blastRecords = await this.getData(opts);\n            const [queryAssembly, targetAssembly] = this.getAssemblyNames();\n            const { refName: queryRefName, assemblyName: queryAssemblyName, start: queryStart, end: queryEnd, } = query;\n            if (queryAssemblyName !== targetAssembly &&\n                queryAssemblyName !== queryAssembly) {\n                console.warn(`${queryAssemblyName} not found in this adapter`);\n                observer.complete();\n                return;\n            }\n            for (let i = 0; i < blastRecords.length; i++) {\n                const r = blastRecords[i];\n                let start;\n                let end;\n                let refName;\n                let assemblyName;\n                let mateStart;\n                let mateEnd;\n                let mateRefName;\n                let mateAssemblyName;\n                const { qseqid, sseqid, qstart, qend, sstart, send, ...rest } = r;\n                if (queryAssemblyName === queryAssembly) {\n                    start = qstart;\n                    end = qend;\n                    refName = qseqid;\n                    assemblyName = queryAssembly;\n                    mateStart = sstart;\n                    mateEnd = send;\n                    mateRefName = sseqid;\n                    mateAssemblyName = targetAssembly;\n                }\n                else {\n                    start = sstart;\n                    end = send;\n                    refName = sseqid;\n                    assemblyName = targetAssembly;\n                    mateStart = qstart;\n                    mateEnd = qend;\n                    mateRefName = qseqid;\n                    mateAssemblyName = queryAssembly;\n                }\n                let strand = 1;\n                let mateStrand = 1;\n                if (start > end) {\n                    ;\n                    [start, end] = [end, start];\n                    strand = -1;\n                }\n                if (mateStart > mateEnd) {\n                    ;\n                    [mateStart, mateEnd] = [mateEnd, mateStart];\n                    mateStrand = -1;\n                }\n                if (refName === queryRefName &&\n                    doesIntersect2(queryStart, queryEnd, start, end)) {\n                    observer.next(new SyntenyFeature({\n                        uniqueId: i + queryAssemblyName,\n                        assemblyName,\n                        start,\n                        end,\n                        type: 'match',\n                        refName,\n                        strand: strand * mateStrand,\n                        syntenyId: i,\n                        ...rest,\n                        mate: {\n                            start: mateStart,\n                            end: mateEnd,\n                            refName: mateRefName,\n                            assemblyName: mateAssemblyName,\n                        },\n                    }));\n                }\n            }\n            observer.complete();\n        });\n    }\n    freeResources() { }\n}\nBlastTabularAdapter.capabilities = ['getFeatures', 'getRefNames'];\nexport default BlastTabularAdapter;\n"],"names":["createBlastLineParser","columns","columnNames","qseqidIndex","sseqidIndex","qstartIndex","qendIndex","sstartIndex","sendIndex","columnNameSet","idx","f","line","row","qseqid","sseqid","qstart","qend","sstart","send","record","columnName","value","BlastTabularAdapter","BaseFeatureDataAdapter","opts","e","pm","buf","fetchAndMaybeUnzip","openLocation","readConfObject","parseLineByLine","assemblyNames","query","target","_a","r1","feats","set","feat","ObservableCreate","observer","blastRecords","queryAssembly","targetAssembly","queryRefName","queryAssemblyName","queryStart","queryEnd","i","r","start","end","refName","assemblyName","mateStart","mateEnd","mateRefName","mateAssemblyName","rest","strand","mateStrand","doesIntersect2","SyntenyFeature"],"mappings":"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","x_google_ignoreList":[0]}